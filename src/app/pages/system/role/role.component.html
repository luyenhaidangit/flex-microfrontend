<div class="container-fluid">
  <app-page-title title="Quản lý vai trò" [breadcrumbItems]="breadCrumbItems"></app-page-title>

  <div class="bg-white rounded shadow-sm p-3">
    <!-- Tabset -->
    <tabset class="nav-pills nav-tabs mb-3">
      <tab heading="Đã duyệt" (selectTab)="switchTab('approved')"></tab>
      <tab heading="Chờ duyệt" (selectTab)="switchTab('pending')"></tab>
    </tabset>

    <!-- Search form -->
    <div class="row gx-3 mb-3 gy-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted">Từ khóa</label>
        <input class="form-control" type="text" placeholder="Nhập từ khóa..." [(ngModel)]="pagingState.keyword">
      </div>
    
      <!-- Chỉ hiện ở tab đã duyệt -->
      <div class="col-md-3" *ngIf="activeTab==='approved'">
        <label class="form-label fw-bold text-muted">Trạng thái</label>
        <select class="form-select" [(ngModel)]="pagingState.isActive">
          <option [ngValue]="null">Tất cả</option>
          <option [ngValue]="true">Hoạt động</option>
          <option [ngValue]="false">Không hoạt động</option>
        </select>
      </div>
    
      <!-- Chỉ hiện ở tab chờ duyệt -->
      <div class="col-md-3" *ngIf="activeTab==='pending'">
        <label class="form-label fw-bold text-muted">Loại yêu cầu</label>
        <select class="form-select" [(ngModel)]="pagingState.type">
          <option [ngValue]="null">Tất cả</option>
          <option [ngValue]="'CREATE'">Tạo mới</option>
          <option [ngValue]="'UPDATE'">Cập nhật</option>
          <option [ngValue]="'DELETE'">Xóa</option>
        </select>
      </div>
    
      <div class="col-md-2">
        <label class="form-label d-block" style="visibility:hidden">Tìm</label>
        <button class="btn btn-primary w-100" (click)="search()">
          <i class="bx bx-search-alt-2"></i> Tìm kiếm
        </button>
      </div>
    
      <div class="col-md-3 text-md-end">
        <button type="button" class="btn btn-success fw-bold" (click)="openCreateModal()">
          <i class="fas fa-plus me-1"></i> Thêm mới
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
        <thead>
          <tr>
            <th *ngFor="let h of headCols">{{ h }}</th>
          </tr>
        </thead>
        
        <tbody *ngIf="isLoading">
          <tr *ngFor="let _ of skeletonRows">
            <td *ngFor="let w of skeletonCols">
              <app-skeleton [width]="w" height="18px"></app-skeleton>
            </td>
          </tr>
        </tbody>

        <!-- TBODY: DATA -->
        <tbody *ngIf="!isLoading">
          <!-- Approved rows -->
          <ng-container *ngIf="activeTab === 'approved'; else pendingRows">
            <tr *ngFor="let item of items; trackBy: trackByCode">
              <td>{{ item.code | safeField }}</td>
              <td>{{ item.name | safeField }}</td>
              <td>{{ item.description | safeField }}</td>
              <td><app-badge [value]="item.isActive" type="status"></app-badge></td>
              <td class="action-column">
                <button class="btn btn-link p-0 text-info" (click)="openDetailModal(item)" title="Xem">
                  <i class="fas fa-eye"></i>
                </button>
        
                <ng-container *ngIf="!item.pendingAction">
                  <button class="btn btn-link p-0 ms-2 text-warning" (click)="openEditModal(item)" title="Sửa">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-link p-0 ms-2 text-danger" (click)="openDeleteModal(item)" title="Xoá">
                    <i class="fas fa-trash"></i>
                  </button>
                </ng-container>
              </td>
            </tr>
        
            <tr *ngIf="items.length === 0">
              <td [attr.colspan]="colspan" class="text-center">Không có dữ liệu</td>
            </tr>
          </ng-container>
        
          <!-- Pending rows -->
          <ng-template #pendingRows>
            <tr *ngFor="let item of pendingItems; trackBy: trackById">
              <td>{{ item.code | safeField }}</td>
              <td>{{ item.name | safeField }}</td>
              <td>{{ item.description | safeField }}</td>
              <td><app-badge [value]="item.requestType" type="request"></app-badge></td>
              <td>{{ item.requestedBy | safeField }}</td>
              <td>{{ item.requestedDate | date:'dd/MM/yyyy' }}</td>
              <td class="action-column">
                <button class="btn btn-link p-0 text-info" (click)="openRequestDetailModal(item)" title="Chi tiết">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-link p-0 ms-2 text-success" (click)="openApproveModal(item)" title="Duyệt">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-link p-0 ms-2 text-danger" (click)="openRejectModal(item)" title="Từ chối">
                  <i class="fas fa-times"></i>
                </button>
              </td>
            </tr>
        
            <tr *ngIf="pendingItems.length === 0">
              <td [attr.colspan]="colspan" class="text-center">Không có yêu cầu chờ duyệt</td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="table-filter d-flex justify-content-between align-items-center mt-2">
      <ul class="pagination mb-0">
        <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
          <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
            <i class="mdi mdi-chevron-left"></i>
          </a>
        </li>
    
        <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index" class="page-item cursor-pointer"
          [class.active]="pagingState.pageIndex === idx + 1">
          <a class="page-link" (click)="changePage(idx + 1)">
            {{ idx + 1 }}
          </a>
        </li>
    
        <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
          <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
            <i class="mdi mdi-chevron-right"></i>
          </a>
        </li>
      </ul>
    
      <!-- page size -->
      <div class="per-page">
        Hiển thị
        <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
          <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
            {{ opt.label }}
          </option>
        </select>
        / {{ pagingState.totalItems }} tổng số bản ghi
      </div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<ng-template #detailModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-info-circle me-2"></i>Chi tiết vai trò
      <app-badge *ngIf="selectedItem?.status" [value]="selectedItem?.status" type="status"></app-badge>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <tabset>
      <tab heading="Thông tin">
        <div class="row gy-2 mt-3">
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Mã vai trò</label>
            <div class="text-dark ps-1">{{ selectedItem?.code | safeField }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Tên vai trò</label>
            <div class="text-dark ps-1">{{ selectedItem?.name | safeField }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Mô tả</label>
            <div class="text-dark ps-1">{{ selectedItem?.description | safeField }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Trạng thái</label>
            <div class="text-dark ps-1">
              <app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
            </div>
          </div>
          <div class="col-md-12" *ngIf="selectedItem?.permissions?.length">
            <label class="form-label fw-bold text-muted">Quyền hạn</label>
            <div class="text-dark ps-1">
              <ng-container *ngFor="let perm of selectedItem.permissions">
                <span class="badge bg-secondary me-1">{{ perm }}</span>
              </ng-container>
            </div>
          </div>
          <div *ngIf="selectedItem?.status === 'REJECTED' && selectedItem?.rejectReason" class="alert alert-danger mt-3">
            <i class="fas fa-ban me-2"></i>
            <strong>Lý do từ chối:</strong> {{ selectedItem?.rejectReason }}
            <div class="small text-muted mt-1">
              Từ chối bởi: {{ selectedItem?.rejectedBy | safeField }} lúc {{ selectedItem?.rejectedDate | date:'dd/MM/yyyy' }}
            </div>
          </div>
        </div>
      </tab>
                      <tab heading="Lịch sử thay đổi" (selectTab)="loadChangeHistory()">
                  <div class="mt-3">
                    <!-- Loading state -->
                    <div *ngIf="isLoading" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                      </div>
                      <p class="mt-2 text-muted">Đang tải lịch sử thay đổi...</p>
                    </div>

                    <!-- History content -->
                    <div *ngIf="!isLoading">
            <div *ngIf="changeHistory?.length; else noHistory">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Thông tin yêu cầu</th>
                      <th>Thông tin duyệt</th>
                      <th>Trạng thái</th>
                      <th>Mô tả thay đổi</th>
                      <th>Thông tin thay đổi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <ng-container *ngFor="let history of changeHistory; let i = index">
                      <!-- Main row -->
                      <tr>
                        <td>
                          <div class="fw-bold">
                            <span *ngIf="history.makerBy">
                              <i class="fas fa-user-edit me-1"></i>{{ history.makerBy }}
                            </span>
                            <span *ngIf="!history.makerBy && history.approverBy">
                              <i class="fas fa-user-check me-1"></i>{{ history.approverBy }}
                            </span>
                          </div>
                          <small class="text-muted">
                            <span *ngIf="history.makerTime">
                              <i class="fas fa-calendar me-1"></i>{{ history.makerTime | date:'dd/MM/yyyy' }}
                              <i class="fas fa-clock ms-2 me-1"></i>{{ history.makerTime | date:'HH:mm:ss' }}
                            </span>
                            <span *ngIf="!history.makerTime && history.approverTime">
                              <i class="fas fa-calendar me-1"></i>{{ history.approverTime | date:'dd/MM/yyyy' }}
                              <i class="fas fa-clock ms-2 me-1"></i>{{ history.approverTime | date:'HH:mm:ss' }}
                            </span>
                          </small>
                        </td>
                        <td>
                          <div class="fw-bold">
                            <span *ngIf="history.approverBy">
                              <i class="fas fa-user-check me-1"></i>{{ history.approverBy }}
                            </span>
                            <span *ngIf="!history.approverBy && history.makerBy">
                              <i class="fas fa-user-edit me-1"></i>{{ history.makerBy }}
                            </span>
                          </div>
                          <small class="text-muted">
                            <span *ngIf="history.approverTime">
                              <i class="fas fa-calendar me-1"></i>{{ history.approverTime | date:'dd/MM/yyyy' }}
                              <i class="fas fa-clock ms-2 me-1"></i>{{ history.approverTime | date:'HH:mm:ss' }}
                            </span>
                            <span *ngIf="!history.approverTime && history.makerTime">
                              <i class="fas fa-calendar me-1"></i>{{ history.makerTime | date:'dd/MM/yyyy' }}
                              <i class="fas fa-clock ms-2 me-1"></i>{{ history.makerTime | date:'HH:mm:ss' }}
                            </span>
                          </small>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <app-badge [value]="history?.status" type="status"></app-badge>
                          </div>
                        </td>
                        <td>
                          <div class="text-dark">{{ history.description }}</div>
                        </td>
                        <td>
                          <div class="text-dark" *ngIf="history.changes">
                            <div class="changes-display">
                              <details class="changes-details">
                                  <summary class="text-primary cursor-pointer">
                                    <i class="fas fa-eye me-1"></i>Xem chi tiết
                                  </summary>
                                  <pre class="mt-2 mb-0 p-2 bg-light rounded" style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">{{ history.changes | prettyJson }}</pre>
                              </details>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
            <ng-template #noHistory>
              <div class="text-muted text-center py-4">
                <i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
                <p>Chưa có lịch sử thay đổi cho vai trò này.</p>
              </div>
            </ng-template>
          </div>
        </div>
      </tab>
    </tabset>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
  </div>
</ng-template>

<!-- Create Modal -->
<ng-template #createModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-success fw-semibold">
        <i class="fas fa-plus-circle me-2"></i>Thêm mới vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã vai trò"
                 [ngClass]="{'is-invalid': roleForm.controls.code.touched && roleForm.controls.code.invalid}"
                 appUpperNoSpace />
          <div *ngIf="roleForm.controls.code.touched && roleForm.controls.code.invalid" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.code.errors?.required">Mã vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.code.errors?.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò"
                 [ngClass]="{'is-invalid': roleForm.controls.name.touched && roleForm.controls.name.invalid}" />
          <div *ngIf="roleForm.controls.name.touched && roleForm.controls.name.invalid" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors?.required">Tên vai trò không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="2" placeholder="Nhập mô tả"></textarea>
        </div>
        <!-- Hidden fields for Create modal -->
        <input type="hidden" formControlName="isActive" value="true">
        <input type="hidden" formControlName="comment" value="">
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      </div>
      <div>
        <button type="button" class="btn btn-primary" (click)="onSubmitRole()">
          <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
        </button>
      </div>
    </div>
  </form>
</ng-template>

<!-- Edit Modal -->
<ng-template #editModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-primary fw-semibold">
        <i class="fas fa-edit me-2"></i>Tạo yêu cầu cập nhật vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <!-- Update Form -->
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò mới"
            [ngClass]="{'is-invalid': roleForm.controls.name.touched && roleForm.controls.name.invalid}" />
          <div *ngIf="roleForm.controls.name.touched && roleForm.controls.name.invalid" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors?.required">Tên vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.name.errors?.maxlength">Tên vai trò không được vượt quá 100 ký tự</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="isActive"
                  [ngClass]="{'is-invalid': roleForm.controls.isActive.touched && roleForm.controls.isActive.invalid}">
            <option [ngValue]="true">Hoạt động</option>
            <option [ngValue]="false">Không hoạt động</option>
          </select>
          <div *ngIf="roleForm.controls.isActive.touched && roleForm.controls.isActive.invalid" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.isActive.errors?.required">Trạng thái không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="3" 
                    placeholder="Nhập mô tả mới (tối đa 500 ký tự)"
                    [ngClass]="{'is-invalid': roleForm.controls.description.touched && roleForm.controls.description.invalid}"></textarea>
          <div *ngIf="roleForm.controls.description.touched && roleForm.controls.description.invalid" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.description.errors?.maxlength">Mô tả không được vượt quá 500 ký tự</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Lý do cập nhật</label>
          <textarea class="form-control" formControlName="comment" rows="3" placeholder="Nhập lý do cập nhật vai trò (tối đa 500 ký tự)"></textarea>
        </div>
      </div>

      <!-- Claims Section (Optional) -->
      <div class="mt-4">
        <h6 class="text-muted mb-3">
          <i class="fas fa-shield-alt me-2"></i>Quyền hạn (tùy chọn)
        </h6>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Lưu ý:</strong> Quyền hạn sẽ được cập nhật theo yêu cầu mới. Hiện tại chưa có giao diện quản lý quyền hạn.
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()" [disabled]="isSubmittingUpdateRequest">
        Hủy
      </button>
      <button type="button" class="btn btn-primary" (click)="submitEditRoleForm()" [disabled]="isSubmittingUpdateRequest">
        <i class="fas fa-paper-plane me-1" *ngIf="!isSubmittingUpdateRequest"></i>
        <span class="spinner-border spinner-border-sm me-1" *ngIf="isSubmittingUpdateRequest" role="status" aria-hidden="true"></span>
        {{ isSubmittingUpdateRequest ? 'Đang gửi yêu cầu...' : 'Gửi yêu cầu cập nhật' }}
      </button>
    </div>
  </form>
</ng-template>

<!-- Delete Modal -->
<ng-template #deleteModal>
  <form [formGroup]="deleteForm" (ngSubmit)="confirmDeleteRole()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-trash-alt me-2"></i>Gửi yêu cầu xóa vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <!-- Role Information -->
      <div class="card border-0 bg-light mb-3">
        <div class="card-body">
          <h6 class="card-title text-muted mb-3">
            <i class="fas fa-info-circle me-2"></i>Thông tin vai trò sẽ xóa
          </h6>
          <div class="row g-2">
            <div class="col-md-6">
              <small class="text-muted">Mã vai trò:</small>
              <div class="fw-bold">{{ selectedItem?.code }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted">Tên vai trò:</small>
              <div class="fw-bold">{{ selectedItem?.name }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted">Trạng thái:</small>
              <div class="fw-bold">
                <app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
              </div>
            </div>
            <div class="col-md-12">
              <small class="text-muted">Mô tả:</small>
              <div class="fw-bold">{{ selectedItem?.description || 'Không có mô tả' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Reason Form -->
      <div class="position-relative">
        <label class="form-label">Lý do xóa</label>
        <textarea class="form-control" formControlName="comment" rows="3"
          placeholder="Nhập lý do xóa vai trò (tối đa 500 ký tự)"
          [ngClass]="{'is-invalid': deleteForm.controls.comment.touched && deleteForm.controls.comment.invalid}">
        </textarea>
        <div *ngIf="deleteForm.controls.comment.touched && deleteForm.controls.comment.invalid" class="invalid-tooltip">
          <span *ngIf="deleteForm.controls.comment.errors?.required">Lý do xóa không được để trống</span>
          <span *ngIf="deleteForm.controls.comment.errors?.maxlength">Lý do xóa không được vượt quá 500 ký tự</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()"
        [disabled]="isSubmittingDeleteRequest">
        Hủy
      </button>
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-paper-plane me-1"></i>
        Gửi yêu cầu xóa
      </button>
    </div>
  </form>
</ng-template>

<!-- Modal phê duyệt yêu cầu -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title text-success fw-semibold">
      <i class="fas fa-check-circle me-2"></i> Xác nhận duyệt yêu cầu
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="card-title text-muted mb-3">
          <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
        </h6>
        <div class="row g-2">
          <div class="col-6">
            <small class="text-muted">ID yêu cầu:</small>
            <div class="fw-bold">{{ selectedItem?.requestId || selectedItem?.id }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Người tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedBy }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Ngày tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedDate | date:'dd/MM/yyyy' }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Loại yêu cầu:</small>
            <div class="fw-bold">
              <app-badge [value]="selectedItem?.requestType" type="request"></app-badge>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-success" (click)="approveRole()">Xác nhận</button>
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal từ chối yêu cầu -->
<ng-template #rejectModal>
  <form [formGroup]="rejectForm" (ngSubmit)="confirmRejectRole()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-times-circle me-2"></i> Từ chối yêu cầu
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="position-relative">
        <label class="form-label">Lý do từ chối</label>
        <textarea
          class="form-control"
          formControlName="reason"
          rows="3"
          placeholder="Nhập lý do từ chối..."
          [ngClass]="{'is-invalid': rejectForm.controls.reason.touched && rejectForm.controls.reason.invalid}">
        </textarea>
        <div *ngIf="rejectForm.controls.reason.touched && rejectForm.controls.reason.invalid" class="invalid-tooltip">
          <span *ngIf="rejectForm.controls.reason.errors?.required">Lý do không được để trống</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="submit" class="btn btn-danger" [disabled]="isRejecting">
        <i class="fas fa-times me-1" *ngIf="!isRejecting"></i>
        <span class="spinner-border spinner-border-sm me-1" *ngIf="isRejecting" role="status" aria-hidden="true"></span>
        {{ isRejecting ? 'Đang từ chối...' : 'Xác nhận từ chối' }}
      </button>
      <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="isRejecting">Hủy</button>
    </div>
  </form>
</ng-template>

<!-- Confirm modal trigger -->
<div *ngIf="showSubmitConfirm">
  <ng-container *ngTemplateOutlet="submitConfirmModal"></ng-container>
</div>

<!-- Enhanced Role Request Detail Modal -->
<ng-template #requestDetailModal>
  <div class="modal-header">
    <h5 class="modal-title fw-semibold">
      <i [class]="getRequestTypeIcon(getRequestType())" 
         [ngClass]="getRequestTypeColor(getRequestType())" 
         class="me-2"></i>
      Chi tiết yêu cầu vai trò
      <span *ngIf="getRequestType()" 
            [ngClass]="getRequestTypeBadgeClass(getRequestType())" 
            class="badge ms-2">
        {{ getRequestTypeLabel(getRequestType()) }}
      </span>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  
  <div class="modal-body px-4 py-3">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin chi tiết...</p>
    </div>

    <!-- Content when data is loaded -->
    <div *ngIf="!isLoading && requestDetailData">
      <!-- Request Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
              </h6>
                             <div class="row g-2">
                 <div class="col-6">
                   <small class="text-muted">ID yêu cầu:</small>
                   <div class="fw-bold">{{ requestDetailData.requestId | safeField }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Người tạo:</small>
                   <div class="fw-bold">{{ getCreatedBy() | safeField }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Ngày tạo:</small>
                   <div class="fw-bold">{{ getCreatedDate() | date:'dd/MM/yyyy' }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Loại yêu cầu:</small>
                  <div class="fw-bold">{{ getRequestTypeLabel(getRequestType()) }}</div>
                 </div>
               </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-tasks me-2"></i>Tóm tắt thay đổi
              </h6>
                             <div class="changes-summary">
                 <div *ngIf="getRequestType() === 'CREATE'" class="text-success">
                   <i class="fas fa-plus-circle me-1"></i>
                   <strong>Tạo mới vai trò:</strong> {{ getRoleName(requestDetailData.newData) }}
                 </div>
                 <div *ngIf="getRequestType() === 'UPDATE'" class="text-warning">
                   <i class="fas fa-edit me-1"></i>
                   <strong>Cập nhật vai trò:</strong> {{ getRoleName(requestDetailData.oldData) }}
                   <div class="small text-muted mt-1">
                     <span class="change-count">Có thay đổi</span>
                   </div>
                 </div>
                 <div *ngIf="getRequestType() === 'DELETE'" class="text-danger">
                   <i class="fas fa-trash-alt me-1"></i>
                   <strong>Xóa vai trò:</strong> {{ getRoleName(requestDetailData.oldData) }}
                 </div>
               </div>
            </div>
          </div>
        </div>
      </div>

             <!-- CREATE Request - Show new data only -->
       <div *ngIf="getRequestType() === 'CREATE'" class="card border-0">
         <div class="card-header bg-success bg-opacity-10 border-0">
           <h6 class="mb-0 text-success">
             <i class="fas fa-plus-circle me-2"></i>Dữ liệu mới sẽ được tạo
           </h6>
         </div>
         <div class="card-body">
           <div class="row g-3">
                           <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Mã vai trò</label>
                <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                  {{ getRoleCode(requestDetailData.newData) | safeField }}
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Tên vai trò</label>
                <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                  {{ getRoleName(requestDetailData.newData) | safeField }}
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold text-muted">Mô tả</label>
               <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                 {{ getRoleDescription(requestDetailData.newData) | safeField }}
               </div>
              </div>
           </div>
         </div>
       </div>

             <!-- UPDATE Request - Show comparison -->
       <div *ngIf="getRequestType() === 'UPDATE'" class="card border-0">
         <div class="card-header bg-warning bg-opacity-10 border-0">
           <h6 class="mb-0 text-warning">
             <i class="fas fa-edit me-2"></i>So sánh thay đổi
           </h6>
         </div>
         <div class="card-body">
           <div class="table-responsive">
             <table class="table table-bordered comparison-table">
               <thead class="table-light">
                 <tr>
                   <th style="width: 25%">Trường dữ liệu</th>
                   <th style="width: 37.5%">Giá trị cũ</th>
                   <th style="width: 37.5%">Giá trị mới</th>
                 </tr>
               </thead>
               <tbody>
                 <tr>
                   <td class="fw-bold">Mã vai trò</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleCode')}">
                     {{ getRoleCode(requestDetailData.oldData) }}
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleCode')}">
                     {{ getRoleCode(requestDetailData.newData) }}
                   </td>
                 </tr>
                 <tr>
                   <td class="fw-bold">Tên vai trò</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleName')}">
                     {{ getRoleName(requestDetailData.oldData) }}
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleName')}">
                     {{ getRoleName(requestDetailData.newData) }}
                   </td>
                 </tr>
                 <tr>
                   <td class="fw-bold">Quyền hạn</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('permissions')}">
                     {{ getPermissions(requestDetailData.oldData).length }} quyền hạn
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('permissions')}">
                     {{ getPermissions(requestDetailData.newData).length }} quyền hạn
                   </td>
                 </tr>
               </tbody>
             </table>
           </div>
         </div>
       </div>

             <!-- DELETE Request - Show data to be deleted -->
       <div *ngIf="getRequestType() === 'DELETE'" class="card border-0">
         <div class="card-header bg-danger bg-opacity-10 border-0">
           <h6 class="mb-0 text-danger">
             <i class="fas fa-trash-alt me-2"></i>Dữ liệu sẽ bị xóa
           </h6>
         </div>
         <div class="card-body">
           <div class="alert alert-danger">
             <i class="fas fa-exclamation-triangle me-2"></i>
             <strong>Cảnh báo:</strong> Vai trò này sẽ bị xóa vĩnh viễn sau khi được phê duyệt.
           </div>
           <div class="row g-3">
                           <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Mã vai trò</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  {{ getRoleCode(requestDetailData.oldData) | safeField }}
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Tên vai trò</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  {{ getRoleName(requestDetailData.oldData) | safeField }}
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold text-muted">Quyền hạn</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  <span *ngIf="getPermissions(requestDetailData.oldData).length > 0; else noPermissionsDelete">
                    {{ getPermissions(requestDetailData.oldData).length }} quyền hạn
                  </span>
                  <ng-template #noPermissionsDelete>Không có quyền hạn</ng-template>
                </div>
              </div>
           </div>
         </div>
       </div>

             <!-- Rejection reason if applicable -->
       <div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
         <i class="fas fa-ban me-2"></i>
         <strong>Lý do từ chối:</strong> {{ requestDetailData.rejectReason }}
         <div class="small text-muted mt-1">
           Từ chối bởi: {{ requestDetailData.rejectedBy | safeField }} 
           lúc {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy' }}
         </div>
       </div>
    </div>

    <!-- Error state -->
    <div *ngIf="!isLoading && !requestDetailData" class="text-center py-4">
      <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
      <p class="mt-2 text-muted">Không thể tải thông tin chi tiết</p>
    </div>
  </div>

  <div class="modal-footer border-top-0">
    <div class="d-flex justify-content-between w-100">
      <div>
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()" [disabled]="isApproving || isRejecting">
          <i class="fas fa-times me-1"></i> Đóng
        </button>
      </div>
      <div class="btn-group-approve-reject">
        <button type="button" class="btn btn-success me-2" (click)="approveRole()">
            Duyệt
        </button>
        <button type="button" class="btn btn-danger" (click)="openRejectModal()">
          <i class="fas fa-times me-1"></i> Từ chối
        </button>
      </div>
    </div>
  </div>
</ng-template>