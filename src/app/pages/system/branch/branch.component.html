<div class="container-fluid">
  <app-page-title
    title="Quản lý chi nhánh"
    [breadcrumbItems]="breadCrumbItems">
  </app-page-title>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">

          <!-- ============ FILTER ============ -->
          <div class="group-action row mb-3">
            <div class="group-action__left col-xl-10 col-md-9 col-sm-12">
              <div class="row">
                <!-- keyword -->
                <div class="form-group col-4">
                  <input class="form-control" type="text" placeholder="Từ khóa tìm kiếm" [(ngModel)]="pagingState.keyword">
                </div>

                <!-- search btn -->
                <div class="form-group col-1">
                  <button class="btn btn-primary waves-effect waves-light" (click)="getItems()">
                    <i class="bx bx-search-alt-2"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- add new -->
            <div class="group-action__right col-xl-2 col-md-3 col-sm-12">
              <button type="button" class="btn btn-success waves-effect waves-light" (click)="openCreateModal()">
                <i class="fas fa-plus me-1"></i> Thêm mới
              </button>              
            </div>
          </div>

          <!-- ============ TABLE ============ -->
          <div class="table-responsive">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã CN</th>
                  <th>Tên chi nhánh</th>
                  <th>Địa chỉ</th>
                  <th>Xử lý</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of items;">
                  <td>{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.address }}</td>

                  <!-- pending -->
                  <td>
                    <ng-container *ngIf="item.pendingAction; else noPending">
                      <span *ngIf="item.pendingAction === 'CREATE'" class="badge badge-soft-success">Chờ duyệt thêm</span>
                      <span *ngIf="item.pendingAction === 'UPDATE'" class="badge badge-soft-warning">Chờ duyệt sửa</span>
                      <span *ngIf="item.pendingAction === 'DELETE'" class="badge badge-soft-danger">Chờ duyệt xóa</span>
                    </ng-container>
                    <ng-template #noPending>—</ng-template>
                  </td>

                  <!-- actions -->
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openDetailModal(detailModal, item)">
                      <i class="fas fa-eye"></i>
                    </span>

                    <ng-container *ngIf="item.pendingAction">
                      <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                        <i class="fas fa-check"></i>
                      </span>
                    </ng-container>

                    <ng-container *ngIf="!item.pendingAction">
                      <span class="text-warning ms-2 pointer" tooltip="Chỉnh sửa">
                        <i class="fas fa-pen"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Xóa">
                        <i class="fas fa-trash"></i>
                      </span>
                    </ng-container>
                  </td>
                </tr>

                <tr *ngIf="items.length === 0">
                  <td colspan="8" class="text-center">Không có dữ liệu</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- ============ PAGINATION ============ -->
          <div class="table-filter d-flex justify-content-between align-items-center mt-2">
            <ul class="pagination mb-0">
              <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
                <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                  <i class="mdi mdi-chevron-left"></i>
                </a>
              </li>

              <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                  class="page-item cursor-pointer"
                  [class.active]="pagingState.pageIndex === idx + 1">
                <a class="page-link" (click)="changePage(idx + 1)">
                  {{ idx + 1 }}
                </a>
              </li>

              <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
                <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                  <i class="mdi mdi-chevron-right"></i>
                </a>
              </li>
            </ul>

            <!-- page size -->
            <div class="per-page">
              Hiển thị
              <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
                <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                  {{ opt.label }}
                </option>
              </select>
              / {{ pagingState.totalItems }} tổng số bản ghi
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chi tiết modal -->
<ng-template #detailModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-info-circle me-2"></i>Chi tiết chi nhánh
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="row gy-3">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Mã CN</label>
        <div class="text-dark ps-1">{{ selectedItem?.code }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tên chi nhánh</label>
        <div class="text-dark ps-1">{{ selectedItem?.name }}</div>
      </div>

      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Địa chỉ</label>
        <div class="text-dark ps-1">
          <i class="fas fa-map-marker-alt text-danger me-2"></i>{{ selectedItem?.address }}
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tình trạng xử lý</label>
        <div class="text-dark ps-1">
          <ng-container [ngSwitch]="selectedItem?.pendingAction">
            <span *ngSwitchCase="'CREATE'" class="badge bg-success">Chờ duyệt thêm</span>
            <span *ngSwitchCase="'UPDATE'" class="badge bg-warning text-dark">Chờ duyệt sửa</span>
            <span *ngSwitchCase="'DELETE'" class="badge bg-danger">Chờ duyệt xóa</span>
            <span *ngSwitchDefault class="badge bg-secondary">Không có yêu cầu</span>
          </ng-container>
        </div>
      </div>

      <div class="col-md-6" *ngIf="selectedItem?.requestedDate">
        <label class="form-label fw-bold text-muted">Ngày yêu cầu</label>
        <div class="text-dark ps-1">
          {{ selectedItem.requestedDate | date: 'dd/MM/yyyy HH:mm:ss' }}
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
  </div>
</ng-template>

<!-- Modal thêm mới chi nhánh -->
<ng-template #createModal>
  <form [formGroup]="branchForm" (ngSubmit)="submitBranchForm()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-success fw-semibold">
        <i class="fas fa-plus-circle me-2"></i>Thêm mới chi nhánh
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã CN</label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã CN"
                 [ngClass]="{'is-invalid': submitted && branchForm.controls.code.errors}" />
          <div *ngIf="submitted && branchForm.controls.code.errors" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.code.errors.required">Mã CN không được để trống</span>
            <span *ngIf="branchForm.controls.code.errors.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên chi nhánh</label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên chi nhánh"
                 [ngClass]="{'is-invalid': submitted && branchForm.controls.name.errors}" />
          <div *ngIf="submitted && branchForm.controls.name.errors" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.name.errors.required">Tên không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Địa chỉ</label>
          <textarea class="form-control" formControlName="address" rows="2" placeholder="Nhập địa chỉ"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save me-1"></i> Gửi yêu cầu
      </button>
      <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
    </div>
  </form>
</ng-template>

<!-- Modal phê duyệt yêu cầu -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title text-success fw-semibold">
      <i class="fas fa-check-circle me-2"></i> Phê duyệt yêu cầu chi nhánh
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="row gy-3">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Mã CN</label>
        <div class="text-dark ps-1">{{ selectedItem?.code }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tên chi nhánh</label>
        <div class="text-dark ps-1">{{ selectedItem?.name }}</div>
      </div>

      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Địa chỉ</label>
        <div class="text-dark ps-1">
          <i class="fas fa-map-marker-alt text-danger me-2"></i>{{ selectedItem?.address || 'Không có' }}
        </div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tình trạng xử lý</label>
        <div class="text-dark ps-1">
          <ng-container [ngSwitch]="selectedItem?.pendingAction">
            <span *ngSwitchCase="'CREATE'" class="badge bg-success">Chờ duyệt thêm</span>
            <span *ngSwitchCase="'UPDATE'" class="badge bg-warning text-dark">Chờ duyệt sửa</span>
            <span *ngSwitchCase="'DELETE'" class="badge bg-danger">Chờ duyệt xóa</span>
            <span *ngSwitchDefault class="badge bg-secondary">Không có yêu cầu</span>
          </ng-container>
        </div>
      </div>

      <div class="col-md-6" *ngIf="selectedItem?.requestedDate">
        <label class="form-label fw-bold text-muted">Ngày yêu cầu</label>
        <div class="text-dark ps-1">
          {{ selectedItem.requestedDate | date: 'dd/MM/yyyy HH:mm:ss' }}
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-success" (click)="approveBranch()">
      <i class="fas fa-check me-1"></i> Duyệt yêu cầu
    </button>
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

