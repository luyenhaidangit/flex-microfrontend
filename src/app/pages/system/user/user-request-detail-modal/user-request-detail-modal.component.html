<!-- User Request Detail Modal -->
<div class="modal fade show d-block" *ngIf="isVisible" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
	<div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title fw-semibold">
					<i [class]="getRequestTypeIcon(getRequestType())" [ngClass]="getRequestTypeColor(getRequestType())" class="me-2"></i>
					Chi tiết yêu cầu người dùng
					<span *ngIf="getRequestType()" [ngClass]="getRequestTypeBadgeClass(getRequestType())" class="badge ms-2">
						{{ getRequestTypeLabel(getRequestType()) }}
					</span>
				</h5>
				<button type="button" class="btn-close" aria-label="Close" (click)="onClose()"></button>
			</div>

			<div class="modal-body px-4 py-3">
				<!-- Loading state -->
				<div *ngIf="isLoadingRequestDetail" class="text-center py-4">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Đang tải...</span>
					</div>
					<p class="mt-2 text-muted">Đang tải thông tin chi tiết...</p>
				</div>

				<!-- Content when data is loaded -->
				<div *ngIf="!isLoadingRequestDetail && requestDetailData">
					<!-- Request Information -->
					<div class="row mb-4">
						<div class="col-md-6">
							<div class="card border-0 bg-light">
								<div class="card-body">
									<h6 class="card-title text-muted mb-3">
										<i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
									</h6>
									<div class="row g-2">
										<div class="col-6">
											<small class="text-muted">ID yêu cầu:</small>
											<div class="fw-bold">{{ requestDetailData.requestId | safeField }}</div>
										</div>
										<div class="col-6">
											<small class="text-muted">Người tạo:</small>
											<div class="fw-bold">{{ getCreatedBy() | safeField }}</div>
										</div>
										<div class="col-6">
											<small class="text-muted">Ngày tạo:</small>
											<div class="fw-bold">{{ getCreatedDate() | date:'dd/MM/yyyy' }}</div>
										</div>
										<div class="col-6">
											<small class="text-muted">Loại yêu cầu:</small>
											<div class="fw-bold">{{ getRequestTypeLabel(getRequestType()) }}</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-6">
							<div class="card border-0 bg-light">
								<div class="card-body">
									<h6 class="card-title text-muted mb-3">
										<i class="fas fa-tasks me-2"></i>Tóm tắt thay đổi
									</h6>
									<div class="changes-summary">
										<div *ngIf="getRequestType() === 'CREATE'" class="text-success">
											<i class="fas fa-plus-circle me-1"></i>
											<strong>Tạo mới người dùng:</strong> {{ getDisplayName(requestDetailData.newData) }}
										</div>
										<div *ngIf="getRequestType() === 'UPDATE'" class="text-warning">
											<i class="fas fa-edit me-1"></i>
											<strong>Cập nhật người dùng:</strong> {{ getDisplayName(requestDetailData.oldData) }}
											<div class="small text-muted mt-1">
												<span class="change-count">Có thay đổi</span>
											</div>
										</div>
										<div *ngIf="getRequestType() === 'DELETE'" class="text-danger">
											<i class="fas fa-trash-alt me-1"></i>
											<strong>Xóa người dùng:</strong> {{ getDisplayName(requestDetailData.oldData) }}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- CREATE Request - Show new data in table format -->
					<div *ngIf="getRequestType() === 'CREATE'" class="card border-0">
						<div class="card-header bg-success bg-opacity-10 border-0">
							<h6 class="mb-0 text-success">
								<i class="fas fa-plus-circle me-2"></i>Dữ liệu mới sẽ được tạo
							</h6>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered comparison-table">
									<thead class="table-light">
										<tr>
											<th style="width: 50%">Trường dữ liệu</th>
											<th style="width: 50%">Giá trị mới</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">Tên đăng nhập</td>
											<td class="bg-success bg-opacity-10">
												{{ getUserName(requestDetailData.newData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Họ và tên</td>
											<td class="bg-success bg-opacity-10">
												{{ getUserFullName(requestDetailData.newData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Email</td>
											<td class="bg-success bg-opacity-10">
												{{ getUserEmail(requestDetailData.newData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Chi nhánh</td>
											<td class="bg-success bg-opacity-10">
												{{ getBranchName(requestDetailData.newData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Trạng thái</td>
											<td class="bg-success bg-opacity-10">
												<i class="fas fa-check-circle text-success me-1"></i>
												Hoạt động
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>

					<!-- UPDATE Request - Show comparison -->
					<div *ngIf="getRequestType() === 'UPDATE'" class="card border-0">
						<div class="card-header bg-warning bg-opacity-10 border-0">
							<h6 class="mb-0 text-warning">
								<i class="fas fa-edit me-2"></i>So sánh thay đổi
							</h6>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered comparison-table">
									<thead class="table-light">
										<tr>
											<th style="width: 25%">Trường dữ liệu</th>
											<th style="width: 37.5%">Giá trị cũ</th>
											<th style="width: 37.5%">Giá trị mới</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">Tên đăng nhập</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('userName')}">
												{{ getUserName(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('userName')}">
												{{ getUserName(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Họ và tên</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('fullName')}">
												{{ getUserFullName(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('fullName')}">
												{{ getUserFullName(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Email</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('email')}">
												{{ getUserEmail(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('email')}">
												{{ getUserEmail(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Chi nhánh</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('branchName')}">
												{{ getBranchName(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('branchName')}">
												{{ getBranchName(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Trạng thái</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('isActive')}">
												<i [class]="getUserStatusIcon(requestDetailData.oldData)" class="me-1"></i>
												{{ getUserStatusText(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('isActive')}">
												<i [class]="getUserStatusIcon(requestDetailData.newData)" class="me-1"></i>
												{{ getUserStatusText(requestDetailData.newData) }}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>

					<!-- DELETE Request - Show data to be deleted -->
					<div *ngIf="getRequestType() === 'DELETE'" class="card border-0">
						<div class="card-header bg-danger bg-opacity-10 border-0">
							<h6 class="mb-0 text-danger">
								<i class="fas fa-trash-alt me-2"></i>Dữ liệu sẽ bị xóa
							</h6>
						</div>
						<div class="card-body">
							<div class="alert alert-danger">
								<i class="fas fa-exclamation-triangle me-2"></i>
								<strong>Cảnh báo:</strong> Người dùng này sẽ bị xóa vĩnh viễn sau khi được phê duyệt.
							</div>
							<div class="table-responsive">
								<table class="table table-bordered comparison-table">
									<thead class="table-light">
										<tr>
											<th style="width: 50%">Trường dữ liệu</th>
											<th style="width: 50%">Giá trị hiện tại</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">Tên đăng nhập</td>
											<td class="bg-danger bg-opacity-10">
												{{ getUserName(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Họ và tên</td>
											<td class="bg-danger bg-opacity-10">
												{{ getUserFullName(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Email</td>
											<td class="bg-danger bg-opacity-10">
												{{ getUserEmail(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Chi nhánh</td>
											<td class="bg-danger bg-opacity-10">
												{{ getBranchName(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">Trạng thái</td>
											<td class="bg-danger bg-opacity-10">
												<i [class]="getUserStatusIcon(requestDetailData.oldData)" class="me-1"></i>
												{{ getUserStatusText(requestDetailData.oldData) }}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>

					<!-- Rejection reason if applicable -->
					<div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
						<i class="fas fa-ban me-2"></i>
						<strong>Lý do từ chối:</strong> {{ requestDetailData.rejectReason }}
						<div class="small text-muted mt-1">
							Từ chối bởi: {{ requestDetailData.rejectedBy | safeField }}
							lúc {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy' }}
						</div>
					</div>
				</div>

				<!-- Error state -->
				<div *ngIf="!isLoadingRequestDetail && !requestDetailData" class="text-center py-4">
					<i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
					<p class="mt-2 text-muted">Không thể tải thông tin chi tiết</p>
				</div>
			</div>

			<div class="modal-footer border-top-0">
				<button type="button" class="btn btn-outline-secondary" (click)="onClose()">
					<i class="fas fa-times me-1"></i> Đóng
				</button>
			</div>
		</div>
	</div>
</div>
