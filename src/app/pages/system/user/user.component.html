<div class="container-fluid">
	<app-page-title title="{{ CONFIG.breadcrumb.title }}" [breadcrumbItems]="CONFIG.breadcrumb.items"></app-page-title>

	<div class="bg-white rounded shadow-sm p-3">

		<!-- Tabset -->
		<app-tabs 
			[tabs]="tabsConfig.items" 
			[activeId]="activeTabId" 
			(activeIdChange)="onTabChange($event)">
		</app-tabs>

		<!-- Search -->
		<div class="row gx-3 mb-3 gy-2 align-items-end">
			<div class="col-md-3">
				<label class="form-label fw-bold text-muted">Từ khóa</label>
				<input class="form-control" type="text" placeholder="Nhập từ khóa..." [(ngModel)]="state.filter.keyword">
			</div>
		
			<!-- Display only in approved tab -->
			<div class="col-md-3" *ngIf="activeTabId === 'approved'">
				<label class="form-label fw-bold text-muted">Chi nhánh</label>
				<select class="form-select" [(ngModel)]="state.filter.branchId">
					<option [ngValue]="null">Tất cả</option>
					<option *ngFor="let branch of branches" [ngValue]="branch.id">
						{{ branch.name }}
					</option>
				</select>
			</div>
		
			<!-- Display only in pending tab -->
			<div class="col-md-3" *ngIf="activeTabId === 'pending'">
				<label class="form-label fw-bold text-muted">Loại yêu cầu</label>
				<select class="form-select" [(ngModel)]="state.filter.type">
					<option [ngValue]="null">Tất cả</option>
					<option [ngValue]="'CREATE'">Tạo mới</option>
					<option [ngValue]="'UPDATE'">Cập nhật</option>
					<option [ngValue]="'DELETE'">Xóa</option>
				</select>
			</div>
		
			<div class="col-md-2">
				<button class="btn btn-primary w-100" (click)="onSearch()">
					<i class="bx bx-search-alt-2"></i> Tìm kiếm
				</button>
			</div>
		
			<div class="col-md-4 text-md-end">
				<button type="button" class="btn btn-success fw-bold" (click)="openCreateModal()">
					<i class="fas fa-plus me-1"></i> Thêm mới
				</button>
			</div>
		</div>

		<div class="table-responsive table-header-primary">
			<table class="table align-middle table-nowrap dt-responsive nowrap w-100">
				<thead>
					<tr>
						<th *ngFor="let col of CONFIG.table.columns[activeTabId]">{{ col.label }}</th>
					</tr>
				</thead>
				<tbody *ngIf="loadingTable">
					<tr *ngFor="let _ of [].constructor(CONFIG.table.skeleton[activeTabId]?.rows || 8)">
						<td *ngFor="let w of CONFIG.table.skeleton[activeTabId]?.columns || []">
							<app-skeleton [width]="w" height="18px"></app-skeleton>
						</td>
					</tr>
				</tbody>
				<tbody *ngIf="!loadingTable && items.length">
					<!-- Approved tab content -->
					<ng-container *ngIf="activeTabId === 'approved'">
						<tr *ngFor="let u of items">
							<td>{{ u.userName | safeField }}</td>
							<td>{{ u.fullName | safeField }}</td>
							<td>{{ u.email | safeField }}</td>
							<td>{{ u.branchName | safeField }}</td>
							<td>
								<app-badge [value]="u.isActive" type="status"></app-badge>
							</td>
							<td class="action-column">
								<button class="btn btn-link p-0 text-info" (click)="openDetailModal(u)" title="Xem">
									<i class="fas fa-eye"></i>
								</button>
								<button class="btn btn-link p-0 ms-2 text-warning" (click)="openEditModal(u)" title="Sửa">
									<i class="fas fa-edit"></i>
								</button>
								<button class="btn btn-link p-0 ms-2 text-danger" (click)="openDeleteModal(u)" title="Xoá">
									<i class="fas fa-trash"></i>
								</button>
							</td>
						</tr>
					</ng-container>
					<!-- Pending tab content -->
					<ng-container *ngIf="activeTabId === 'pending'">
						<tr *ngFor="let u of items">
							<td>{{ u.userName | safeField }}</td>
							<td>{{ u.fullName | safeField }}</td>
							<td>{{ u.email | safeField }}</td>
							<td>
								<app-badge [value]="item.requestType" type="request"></app-badge>
							</td>
							<td>{{ u.requestedDate | date:'dd/MM/yyyy HH:mm' }}</td>
							<td>{{ u.makerName | safeField }}</td>
							<td class="action-column">
								<button class="btn btn-link p-0 text-info" (click)="openPendingDetailModal(u)" title="Xem chi tiết">
									<i class="fas fa-eye"></i>
								</button>
								<button class="btn btn-link p-0 ms-2 text-success" (click)="openApproveModal(u)" title="Duyệt">
									<i class="fas fa-check"></i>
								</button>
								<button class="btn btn-link p-0 ms-2 text-danger" (click)="openRejectModal(u)" title="Từ chối">
									<i class="fas fa-times"></i>
								</button>
							</td>
						</tr>
					</ng-container>
				</tbody>
				<tbody *ngIf="!loadingTable && !items.length">
					<tr>
						<td [attr.colspan]="CONFIG.table.columns[activeTabId]?.length || 0" class="text-center text-muted">Không có dữ liệu</td>
					</tr>
				</tbody>
			</table>
		</div>

		<!-- Pagination -->
		<div class="table-filter d-flex justify-content-between align-items-center mt-2">
			<ul class="pagination mb-0">
				<li class="page-item cursor-pointer" [class.disabled]="state.paging.index === 1">
					<a class="page-link" (click)="onPageChange(state.paging.index - 1)">
						<i class="mdi mdi-chevron-left"></i>
					</a>
				</li>
			
				<li *ngFor="let _ of [].constructor(state.paging.totalPages); let idx = index" class="page-item cursor-pointer"
					[class.active]="state.paging.index === idx + 1">
					<a class="page-link" (click)="onPageChange(idx + 1)">
						{{ idx + 1 }}
					</a>
				</li>
			
				<li class="page-item cursor-pointer" [class.disabled]="state.paging.index === state.paging.totalPages">
					<a class="page-link" (click)="onPageChange(state.paging.index + 1)">
						<i class="mdi mdi-chevron-right"></i>
					</a>
				</li>
			</ul>
		
			<!-- page size -->
			<div class="per-page">
				Hiển thị
				<select class="mx-1 cursor-pointer" [(ngModel)]="state.paging.size" (change)="onPageSizeChange()">
					<option *ngFor="let opt of paginationConfig.pageSizeOptions" [ngValue]="opt.value" class="cursor-pointer">
						{{ opt.label  }}
					</option>
				</select>
				/ {{ state.paging.totalItems }} tổng số bản ghi
			</div>
		</div>
	</div>
</div>

<!-- Modal -->
<!-- Detail Modal -->
<ng-template #detailModal>
	<div class="modal-header">
		<h5 class="modal-title text-primary fw-semibold">
			<i class="fas fa-info-circle me-2"></i>Chi tiết người dùng
			<app-badge *ngIf="selectedItem?.isActive !== undefined" [value]="selectedItem?.isActive" type="status"></app-badge>
		</h5>
		<button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
	</div>
	<div class="modal-body px-4 py-3">
		<tabset>
			<tab heading="Thông tin">
				<div class="row gy-2 mt-3">
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Tên đăng nhập</label>
						<div class="text-dark ps-1">{{ selectedItem?.userName | safeField }}</div>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Họ và tên</label>
						<div class="text-dark ps-1">{{ selectedItem?.fullName | safeField }}</div>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Email</label>
						<div class="text-dark ps-1">{{ selectedItem?.email | safeField }}</div>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Chi nhánh</label>
						<div class="text-dark ps-1">{{ selectedItem?.branchName | safeField }}</div>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Trạng thái</label>
						<div class="text-dark ps-1">
							<app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
						</div>
					</div>
					<div class="col-md-6">
						<label class="form-label fw-bold text-muted">Ngày tạo</label>
						<div class="text-dark ps-1">{{ selectedItem?.createdAt | date:'dd/MM/yyyy HH:mm' | safeField }}</div>
					</div>
				</div>
			</tab>
			<tab heading="Lịch sử thay đổi" (selectTab)="loadChangeHistory()">
				<div class="mt-3">
					<!-- Loading state -->
					<div *ngIf="isLoadingHistory" class="text-center py-4">
						<div class="spinner-border text-primary" role="status">
							<span class="visually-hidden">Đang tải...</span>
						</div>
						<p class="mt-2 text-muted">Đang tải lịch sử thay đổi...</p>
					</div>

					<!-- History content -->
					<div *ngIf="!isLoadingHistory">
						<div *ngIf="changeHistory?.length; else noHistory">
							<div class="table-responsive">
								<table class="table table-hover">
									<thead class="table-light">
										<tr>
											<th>Thông tin yêu cầu</th>
											<th>Thông tin duyệt</th>
											<th>Trạng thái</th>
											<th>Mô tả thay đổi</th>
											<th>Thông tin thay đổi</th>
										</tr>
									</thead>
									<tbody>
										<ng-container *ngFor="let history of changeHistory; let i = index">
											<!-- Main row -->
											<tr>
												<td>
													<div class="fw-bold">
														<span *ngIf="history.makerBy">
															<i class="fas fa-user-edit me-1"></i>{{ history.makerBy }}
														</span>
														<span *ngIf="!history.makerBy && history.approverBy">
															<i class="fas fa-user-check me-1"></i>{{ history.approverBy }}
														</span>
													</div>
													<small class="text-muted">
														<span *ngIf="history.makerTime">
															<i class="fas fa-calendar me-1"></i>{{ history.makerTime | date:'dd/MM/yyyy' }}
															<i class="fas fa-clock ms-2 me-1"></i>{{ history.makerTime | date:'HH:mm:ss' }}
														</span>
														<span *ngIf="!history.makerTime && history.approverTime">
															<i class="fas fa-calendar me-1"></i>{{ history.approverTime | date:'dd/MM/yyyy' }}
															<i class="fas fa-clock ms-2 me-1"></i>{{ history.approverTime | date:'HH:mm:ss' }}
														</span>
													</small>
												</td>
												<td>
													<div class="fw-bold">
														<span *ngIf="history.approverBy">
															<i class="fas fa-user-check me-1"></i>{{ history.approverBy }}
														</span>
														<span *ngIf="!history.approverBy && history.makerBy">
															<i class="fas fa-user-edit me-1"></i>{{ history.makerBy }}
														</span>
													</div>
													<small class="text-muted">
														<span *ngIf="history.approverTime">
															<i class="fas fa-calendar me-1"></i>{{ history.approverTime | date:'dd/MM/yyyy' }}
															<i class="fas fa-clock ms-2 me-1"></i>{{ history.approverTime | date:'HH:mm:ss' }}
														</span>
														<span *ngIf="!history.approverTime && history.makerTime">
															<i class="fas fa-calendar me-1"></i>{{ history.makerTime | date:'dd/MM/yyyy' }}
															<i class="fas fa-clock ms-2 me-1"></i>{{ history.makerTime | date:'HH:mm:ss' }}
														</span>
													</small>
												</td>
												<td>
													<div class="d-flex align-items-center">
														<app-badge [value]="history?.status" type="status"></app-badge>
													</div>
												</td>
												<td>
													<div class="text-dark">{{ history.description }}</div>
												</td>
												<td>
													<div class="text-dark" *ngIf="history.changes">
														<div class="changes-display">
															<details class="changes-details">
																<summary class="text-primary cursor-pointer">
																	<i class="fas fa-eye me-1"></i>Xem chi tiết
																</summary>
																<pre class="mt-2 mb-0 p-2 bg-light rounded"
																	style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">{{ history.changes | prettyJson }}</pre>
															</details>
														</div>
													</div>
												</td>
											</tr>
										</ng-container>
									</tbody>
								</table>
							</div>
						</div>
						<ng-template #noHistory>
							<div class="text-muted text-center py-4">
								<i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
								<p>Chưa có lịch sử thay đổi cho người dùng này.</p>
							</div>
						</ng-template>
					</div>
				</div>
			</tab>
		</tabset>
	</div>
	<div class="modal-footer border-top-0">
		<button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
	</div>
</ng-template>