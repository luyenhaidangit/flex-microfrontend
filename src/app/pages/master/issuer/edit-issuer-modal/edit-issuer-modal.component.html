<!-- Edit Issuer Modal -->
<div class="modal fade show d-block" *ngIf="isVisible" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-warning fw-semibold">
          <i class="fas fa-edit me-2"></i>Chỉnh sửa tổ chức phát hành
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="onCancel()"></button>
      </div>

      <form [formGroup]="issuerForm" (ngSubmit)="onSubmit()" class="needs-validation">
        <div class="modal-body px-4 py-3">
    <!-- Loading state for initial data -->
    <div *ngIf="isLoadingInitial" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin tổ chức phát hành...</p>
    </div>

    <!-- Form content -->
    <div *ngIf="!isLoadingInitial" class="row gy-3">
      <!-- Mã tổ chức phát hành -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Mã tổ chức phát hành <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control non-editable-field"
          formControlName="issuerCode"
          placeholder="Mã tổ chức phát hành"
          [ngClass]="{'is-invalid': isFieldInvalid('issuerCode')}"
          appUpperNoSpace
          readonly />
        <div class="form-text text-muted">
          <i class="fas fa-info-circle me-1"></i>Mã tổ chức phát hành không thể thay đổi
        </div>
        <div *ngIf="isFieldInvalid('issuerCode')" class="invalid-tooltip">
          {{ getFieldError('issuerCode') }}
        </div>
      </div>

      <!-- Tên viết tắt -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Tên viết tắt <span class="text-danger">*</span></label>
        <input 
          type="text" 
          class="form-control" 
          formControlName="shortName" 
          placeholder="Nhập tên viết tắt"
          [ngClass]="{'is-invalid': isFieldInvalid('shortName')}" />
        <div *ngIf="isFieldInvalid('shortName')" class="invalid-tooltip">
          {{ getFieldError('shortName') }}
        </div>
      </div>

      <!-- Tên đầy đủ -->
      <div class="col-md-12 position-relative">
        <label class="form-label">Tên đầy đủ <span class="text-danger">*</span></label>
        <input 
          type="text" 
          class="form-control" 
          formControlName="fullName" 
          placeholder="Nhập tên đầy đủ tổ chức phát hành"
          [ngClass]="{'is-invalid': isFieldInvalid('fullName')}" />
        <div *ngIf="isFieldInvalid('fullName')" class="invalid-tooltip">
          {{ getFieldError('fullName') }}
        </div>
      </div>

      <!-- Ghi chú -->
      <div class="col-md-12 position-relative">
        <label class="form-label">Ghi chú</label>
        <textarea 
          class="form-control" 
          formControlName="comment" 
          placeholder="Nhập ghi chú (tùy chọn)"
          rows="3"
          [ngClass]="{'is-invalid': isFieldInvalid('comment')}"></textarea>
        <div *ngIf="isFieldInvalid('comment')" class="invalid-tooltip">
          {{ getFieldError('comment') }}
        </div>
      </div>

    </div>

    <!-- Changes indicator -->
    <div *ngIf="!isLoadingInitial && hasChanges()" class="alert alert-info mt-3 mb-0">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>Lưu ý:</strong> Bạn đã thay đổi thông tin tổ chức phát hành. Những thay đổi này sẽ được gửi để duyệt.
    </div>
  </div>

        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-outline-secondary me-2" (click)="onCancel()" [disabled]="isSubmitting || isLoadingInitial">
            Hủy
          </button>
          <button 
            type="submit" 
            class="btn btn-warning" 
            [disabled]="isSubmitting || isLoadingInitial || issuerForm.invalid || !hasChanges()">
            <i class="fas fa-paper-plane me-1" *ngIf="!isSubmitting"></i>
            <span class="spinner-border spinner-border-sm me-1" *ngIf="isSubmitting" role="status" aria-hidden="true"></span>
            {{ isSubmitting ? 'Đang gửi...' : 'Gửi duyệt' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
