<!-- Issuer Request Detail Modal -->
<div class="modal fade show d-block" *ngIf="isVisible" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
	<div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title fw-semibold" [ngClass]="getRequestTypeColor(getRequestType())">
					<i [class]="getRequestTypeIcon(getRequestType())" [ngClass]="getRequestTypeColor(getRequestType())" class="me-2"></i>
					Chi ti·∫øt y√™u c·∫ßu t·ªï ch·ª©c ph√°t h√†nh
					<span *ngIf="getRequestType()" [ngClass]="getRequestTypeBadgeClass(getRequestType())" class="badge ms-2">
						{{ getRequestTypeLabel(getRequestType()) }}
					</span>
				</h5>
				<button type="button" class="btn-close" aria-label="Close" (click)="onClose()"></button>
			</div>
			
			<div class="modal-body px-4 py-3">
				<!-- Loading state -->
				<div *ngIf="isLoadingRequestDetail" class="text-center py-4">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">ƒêang t·∫£i...</span>
					</div>
					<p class="mt-2 text-muted">ƒêang t·∫£i th√¥ng tin chi ti·∫øt...</p>
				</div>
				
				<!-- Content when data is loaded -->
				<div *ngIf="!isLoadingRequestDetail && requestDetailData">
					<!-- Request Header -->
					<div class="mb-4">
						<!-- Approval Workflow Timeline -->
						<div class="card border-0 mb-4">
							<div class="card-header bg-light border-0">
								<div class="d-flex justify-content-between align-items-center">
									<h6 class="mb-0 fw-bold">Ti·∫øn tr√¨nh duy·ªát</h6>
									<div class="text-muted small">
										<i class="fas fa-hashtag me-1"></i>M√£ y√™u c·∫ßu: <strong>{{ requestDetailData.requestId | safeField }}</strong>
									</div>
								</div>
							</div>
							<div class="card-body">
								<div class="timeline-horizontal">
									<div *ngFor="let step of getWorkflowSteps(); let i = index" class="timeline-item-horizontal">
										<div class="timeline-step-content">
											<div class="timeline-marker-horizontal mb-2">
												<i [class]="getStepIconClass(step.status)" style="font-size: 1.5rem;"></i>
											</div>
											<div class="timeline-step-info">
												<div class="mb-2">
													<h6 class="mb-1 fw-semibold text-center">{{ step.label }}</h6>
													<div class="text-center">
														<span [ngClass]="getStepBadgeClass(step.status)" class="badge">
															{{ step.status === 'completed' ? 'Ho√†n th√†nh' : step.status === 'current' ? 'ƒêang x·ª≠ l√Ω' : 'Ch·ªù x·ª≠ l√Ω' }}
														</span>
													</div>
												</div>
												<div *ngIf="step.date" class="text-muted small text-center">
													<div>
														<i class="fas fa-calendar-alt me-1"></i>{{ step.date | date:'dd/MM/yyyy' }}
														<span *ngIf="step.user" class="">
															| <i class="fas fa-user me-1"></i>{{ step.user }}
														</span>
													</div>
													<div *ngIf="step.comment" class="mt-1">
														<i class="fas fa-comment me-1"></i>{{ step.comment }}
													</div>
												</div>
												<div *ngIf="!step.date && step.status === 'pending'" class="text-muted small text-center">
													Ch∆∞a th·ª±c hi·ªán
												</div>
											</div>
										</div>
										<div *ngIf="i < getWorkflowSteps().length - 1" class="timeline-connector-horizontal" 
											[ngClass]="{'line-completed': step.status === 'completed', 'line-pending': step.status !== 'completed'}">
										</div>
									</div>
								</div>
							</div>
						</div>
						
						<!-- Action Summary for UPDATE -->
						<div *ngIf="getRequestType() === 'UPDATE'" class="alert alert-warning mb-4">
							<div class="fw-bold mb-2">‚ö†Ô∏è S·∫Ω c·∫≠p nh·∫≠t t·ªï ch·ª©c ph√°t h√†nh:</div>
							<div class="ms-3">
								<strong>{{ getIssuerCode(requestDetailData.oldData) }}</strong> ‚Äì {{ getDisplayName(requestDetailData.oldData) }}
							</div>
						</div>
						
						<!-- Action Summary for DELETE -->
						<div *ngIf="getRequestType() === 'DELETE'" class="alert alert-danger mb-4">
							<div class="fw-bold mb-2">üóëÔ∏è S·∫Ω x√≥a t·ªï ch·ª©c ph√°t h√†nh:</div>
							<div class="ms-3">
								<strong>{{ getIssuerCode(requestDetailData.oldData) }}</strong> ‚Äì {{ getDisplayName(requestDetailData.oldData) }}
							</div>
						</div>
					</div>
					
					<!-- CREATE Request - Show new data in table format -->
					<div *ngIf="getRequestType() === 'CREATE'" class="card border-0 mb-4">
						<div class="card-header bg-light border-0">
							<h6 class="mb-0 fw-bold">
								Th√¥ng tin y√™u c·∫ßu
							</h6>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered mb-0">
									<thead class="table-light">
										<tr>
											<th style="width: 50%">Tr∆∞·ªùng d·ªØ li·ªáu</th>
											<th style="width: 50%">Gi√° tr·ªã m·ªõi</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">M√£ t·ªï ch·ª©c ph√°t h√†nh</td>
											<td>{{ getIssuerCode(requestDetailData.newData) | safeField }}</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n vi·∫øt t·∫Øt</td>
											<td>{{ getIssuerShortName(requestDetailData.newData) | safeField }}</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n ƒë·∫ßy ƒë·ªß</td>
											<td>{{ getIssuerFullName(requestDetailData.newData) | safeField }}</td>
										</tr>
										<tr>
											<td class="fw-bold">Lo·∫°i t·ªï ch·ª©c</td>
											<td>{{ getOrganizationType(requestDetailData.newData) }}</td>
										</tr>
										<tr>
											<td class="fw-bold">Ng√†y ƒëƒÉng k√Ω</td>
											<td>{{ getRegistrationDate(requestDetailData.newData) | date:'dd/MM/yyyy' }}</td>
										</tr>
										<tr *ngIf="getComment(requestDetailData.newData)">
											<td class="fw-bold">Ghi ch√∫</td>
											<td>{{ getComment(requestDetailData.newData) | safeField }}</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					
					<!-- Securities List for CREATE Request -->
					<div *ngIf="getRequestType() === 'CREATE' && getSecuritiesList(requestDetailData.newData)?.length > 0" class="card border-0 mb-4">
						<div class="card-header bg-light border-0">
							<h6 class="mb-0 fw-bold">
								üìë Danh s√°ch ch·ª©ng kho√°n ƒë∆∞·ª£c t·∫°o c√πng ({{ getSecuritiesList(requestDetailData.newData).length }})
							</h6>
						</div>
						<div class="card-body">
							<div *ngFor="let securities of getSecuritiesList(requestDetailData.newData); let i = index" class="border rounded mb-3">
								<div class="p-3 bg-light" (click)="toggleSecurities(i)" style="cursor: pointer;">
									<span class="me-2">{{ isSecuritiesExpanded(i) ? '‚ñº' : '‚ñ∂' }}</span>
									<strong>{{ getSecuritiesDisplayName(securities) }}</strong>
								</div>
								<div *ngIf="isSecuritiesExpanded(i)" class="p-3">
									<table class="table table-sm table-bordered mb-0">
										<thead class="table-light">
											<tr>
												<th style="width: 50%">Tr∆∞·ªùng</th>
												<th style="width: 50%">Gi√° tr·ªã m·ªõi</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td class="fw-bold">ISIN Code</td>
												<td>{{ getSecuritiesIsinCode(securities) | safeField }}</td>
											</tr>
											<tr>
												<td class="fw-bold">T√™n ch·ª©ng kho√°n</td>
												<td>{{ getSecuritiesSymbol(securities) | safeField }}</td>
											</tr>
											<tr>
												<td class="fw-bold">Lo·∫°i ch·ª©ng kho√°n</td>
												<td>{{ getSecuritiesType(securities) }}</td>
											</tr>
											<tr *ngIf="getSecuritiesFaceValue(securities) !== '‚Äî'">
												<td class="fw-bold">M·ªánh gi√°</td>
												<td>{{ getSecuritiesFaceValue(securities) }}</td>
											</tr>
											<tr *ngIf="getSecuritiesListingDate(securities)">
												<td class="fw-bold">Ng√†y ni√™m y·∫øt</td>
												<td>{{ getSecuritiesListingDate(securities) | date:'dd/MM/yyyy' }}</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
					
					<!-- UPDATE Request - Show comparison -->
					<div *ngIf="getRequestType() === 'UPDATE'" class="card border-0">
						<div class="card-header bg-warning bg-opacity-10 border-0">
							<h6 class="mb-0 text-warning">
								<i class="fas fa-edit me-2"></i>So s√°nh thay ƒë·ªïi
							</h6>
						</div>
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered comparison-table">
									<thead class="table-light">
										<tr>
											<th style="width: 25%">Tr∆∞·ªùng d·ªØ li·ªáu</th>
											<th style="width: 37.5%">Gi√° tr·ªã c≈©</th>
											<th style="width: 37.5%">Gi√° tr·ªã m·ªõi</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">M√£ t·ªï ch·ª©c ph√°t h√†nh</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('issuerCode')}">
												{{ getIssuerCode(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('issuerCode')}">
												{{ getIssuerCode(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n vi·∫øt t·∫Øt</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('shortName')}">
												{{ getIssuerShortName(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('shortName')}">
												{{ getIssuerShortName(requestDetailData.newData) }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n ƒë·∫ßy ƒë·ªß</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('fullName')}">
												{{ getIssuerFullName(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('fullName')}">
												{{ getIssuerFullName(requestDetailData.newData) }}
											</td>
										</tr>
										<tr *ngIf="getComment(requestDetailData.oldData) || getComment(requestDetailData.newData)">
											<td class="fw-bold">Ghi ch√∫</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('comment')}">
												{{ getComment(requestDetailData.oldData) }}
											</td>
											<td [ngClass]="{'bg-light-warning': hasChanges('comment')}">
												{{ getComment(requestDetailData.newData) }}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					
					<!-- DELETE Request - Show data to be deleted -->
					<div *ngIf="getRequestType() === 'DELETE'" class="card border-0">
						<div class="card-header bg-danger bg-opacity-10 border-0">
							<h6 class="mb-0 text-danger">
								<i class="fas fa-trash-alt me-2"></i>D·ªØ li·ªáu s·∫Ω b·ªã x√≥a
							</h6>
						</div>
						<div class="card-body">
							<div class="alert alert-danger">
								<i class="fas fa-exclamation-triangle me-2"></i>
								<strong>C·∫£nh b√°o:</strong> T·ªï ch·ª©c ph√°t h√†nh n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn sau khi ƒë∆∞·ª£c ph√™ duy·ªát.
							</div>
							<div class="table-responsive">
								<table class="table table-bordered comparison-table">
									<thead class="table-light">
										<tr>
											<th style="width: 50%">Tr∆∞·ªùng d·ªØ li·ªáu</th>
											<th style="width: 50%">Gi√° tr·ªã hi·ªán t·∫°i</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="fw-bold">M√£ t·ªï ch·ª©c ph√°t h√†nh</td>
											<td class="bg-danger bg-opacity-10">
												{{ getIssuerCode(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n vi·∫øt t·∫Øt</td>
											<td class="bg-danger bg-opacity-10">
												{{ getIssuerShortName(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr>
											<td class="fw-bold">T√™n ƒë·∫ßy ƒë·ªß</td>
											<td class="bg-danger bg-opacity-10">
												{{ getIssuerFullName(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
										<tr *ngIf="getReason(requestDetailData.oldData)">
											<td class="fw-bold">L√Ω do x√≥a</td>
											<td class="bg-danger bg-opacity-10">
												{{ getReason(requestDetailData.oldData) | safeField }}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					
					<!-- Rejection reason if applicable -->
					<div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
						<i class="fas fa-ban me-2"></i>
						<strong>L√Ω do t·ª´ ch·ªëi:</strong> {{ requestDetailData.rejectReason }}
						<div class="small text-muted mt-1">
							T·ª´ ch·ªëi b·ªüi: {{ requestDetailData.rejectedBy | safeField }}
							l√∫c {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy' }}
						</div>
					</div>
				</div>
				
				<!-- Error state -->
				<div *ngIf="!isLoadingRequestDetail && !requestDetailData" class="text-center py-4">
					<i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
					<p class="mt-2 text-muted">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt</p>
				</div>
			</div>
			
			<div class="modal-footer border-top-0">
				<button type="button" class="btn btn-outline-secondary" (click)="onClose()">
					<i class="fas fa-times me-1"></i> ƒê√≥ng
				</button>
			</div>
		</div>
	</div>
</div>
