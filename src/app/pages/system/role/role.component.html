<div class="container-fluid">
  <app-page-title title="Quản lý vai trò" [breadcrumbItems]="breadCrumbItems">
  </app-page-title>
  <div class="role-header sticky-top bg-white p-3 mb-3" style="z-index: 10;">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
      <div class="flex-grow-1"></div>
      <div class="d-flex gap-2 ms-auto">
        <button type="button" class="btn btn-success fw-bold shadow-sm" (click)="openCreateModal()" style="min-width: 120px;">
          <i class="fas fa-plus me-1"></i> Thêm mới
        </button>
        <button type="button" class="btn btn-outline-secondary">
          <i class="fas fa-file-export me-1"></i> Xuất
        </button>
      </div>
    </div>
    <div class="row gx-3 gy-2 align-items-end">
      <div class="col-md-4 mb-2 mb-md-0">
        <div class="form-group">
          <label class="form-label fw-bold text-muted" for="keywordInput">Từ khóa tìm kiếm</label>
          <input id="keywordInput" class="form-control" type="text" placeholder="Nhập từ khóa..." [(ngModel)]="pagingState.keyword">
        </div>
      </div>
      <div class="col-md-3 mb-2 mb-md-0">
        <div class="form-group">
          <label class="form-label fw-bold text-muted" for="statusSelect">Trạng thái</label>
          <select id="statusSelect" class="form-select" [(ngModel)]="pagingState.status">
            <option value="">Tất cả trạng thái</option>
            <option value="DRF">Nháp</option>
            <option value="UNA">Chờ duyệt</option>
            <option value="AUT">Đã duyệt</option>
            <option value="REJ">Từ chối</option>
          </select>
        </div>
      </div>
      <div class="col-md-3 mb-2 mb-md-0">
        <div class="form-group">
          <label class="form-label fw-bold text-muted" for="createdDateInput">Ngày tạo</label>
          <div class="position-relative">
            <span class="position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #bfc9da; pointer-events: none;">
              <i class="bx bx-calendar"></i>
            </span>
            <input id="createdDateInput" type="text" class="form-control ps-5" placeholder="Chọn ngày..." bsDatepicker [(ngModel)]="pagingState.createdDate" [bsConfig]="{ showWeekNumbers: false, dateInputFormat: 'DD/MM/YYYY' }">
          </div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
          <label class="form-label d-block" style="visibility:hidden">Tìm kiếm</label>
          <button class="btn btn-primary w-100" (click)="search()">
            <i class="bx bx-search-alt-2"></i> Tìm kiếm
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded shadow-sm p-3">
    <tabset class="nav-pills nav-tabs mb-3">
      <tab heading="Đã duyệt" (selectTab)="switchTab('approved')">
        <!-- ============ TABLE ============ -->
        <div class="table-responsive">
          <ng-container *ngIf="isLoading; else tableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Xử lý</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5]">
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="180px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="60px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="60px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <ng-template #tableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Xử lý</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of items;">
                  <td>{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.description }}</td>
                  <td>
                    <span 
                      class="badge font-size-11"
                      [ngClass]="{
                        'badge-soft-secondary': (item.status || '').toUpperCase() === 'DRF',
                        'badge-soft-warning': (item.status || '').toUpperCase() === 'UNA',
                        'badge-soft-success': (item.status || '').toUpperCase() === 'AUT',
                        'badge-soft-danger': (item.status || '').toUpperCase() === 'REJ'
                      }"
                    >
                      {{ statusLabel(item.status) }}
                    </span>
                  </td>
                  <td>{{ item.requestedBy }}</td>
                  <td>{{ item.requestedDate | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ item.status === 'Approved' ? (item.approveDate | date: 'dd/MM/yyyy HH:mm:ss') : '—' }}</td>
                  <td>
                    <ng-container *ngIf="item.pendingAction; else noPending">
                      <span *ngIf="item.pendingAction === 'CREATE'" class="badge badge-soft-success">Chờ duyệt thêm</span>
                      <span *ngIf="item.pendingAction === 'UPDATE'" class="badge badge-soft-warning">Chờ duyệt sửa</span>
                      <span *ngIf="item.pendingAction === 'DELETE'" class="badge badge-soft-danger">Chờ duyệt xoá</span>
                    </ng-container>
                    <ng-template #noPending>—</ng-template>
                  </td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openRequestDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <ng-container *ngIf="item.pendingAction === 'CREATE'">
                      <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                        <i class="fas fa-check"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                        <i class="fas fa-times"></i>
                      </span>
                    </ng-container>
                    <ng-container *ngIf="!item.pendingAction">
                      <span class="text-warning ms-2 pointer" tooltip="Chỉnh sửa" (click)="openEditModal(item)">
                        <i class="fas fa-pen"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Xoá" (click)="openDeleteModal(item)">
                        <i class="fas fa-trash"></i>
                      </span>
                    </ng-container>
                  </td>
                </tr>
                <tr *ngIf="items.length === 0">
                  <td colspan="9" class="text-center">Không có dữ liệu</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <!-- ============ PAGINATION ============ -->
        <div class="table-filter d-flex justify-content-between align-items-center mt-2">
          <ul class="pagination mb-0">
            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
              <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                <i class="mdi mdi-chevron-left"></i>
              </a>
            </li>

            <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                class="page-item cursor-pointer"
                [class.active]="pagingState.pageIndex === idx + 1">
              <a class="page-link" (click)="changePage(idx + 1)">
                {{ idx + 1 }}
              </a>
            </li>

            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
              <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                <i class="mdi mdi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <!-- page size -->
          <div class="per-page">
            Hiển thị
            <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
              <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                {{ opt.label }}
              </option>
            </select>
            / {{ pagingState.totalItems }} tổng số bản ghi
          </div>
        </div>
      </tab>
      <tab heading="Chờ duyệt" (selectTab)="switchTab('pending')">
        <div class="table-responsive">
          <ng-container *ngIf="isLoading; else pendingTableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5]">
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="180px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <ng-template #pendingTableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of pendingItems;">
                  <td>{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.description }}</td>
                  <td>
                    <span class="badge font-size-11"
                      [ngClass]="{
                        'badge-soft-success': (item.requestType || '').toUpperCase() === 'CREATE',
                        'badge-soft-warning': (item.requestType || '').toUpperCase() === 'UPDATE',
                        'badge-soft-danger': (item.requestType || '').toUpperCase() === 'DELETE'
                      }"
                    >
                      {{ getRequestTypeLabel(item.requestType) }}
                    </span>
                  </td>
                  <td>{{ item.requestedBy }}</td>
                  <td>{{ item.requestedDate | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ item.status === 'Approved' ? (item.approveDate | date: 'dd/MM/yyyy HH:mm:ss') : '—' }}</td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openRequestDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                      <i class="fas fa-check"></i>
                    </span>
                    <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                      <i class="fas fa-times"></i>
                    </span>
                  </td>
                </tr>
                <tr *ngIf="pendingItems.length === 0">
                  <td colspan="8" class="text-center">Không có yêu cầu chờ duyệt</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>
      </tab>
      <tab heading="Nháp" (selectTab)="switchTab('draft')">
        <div class="alert alert-secondary">Danh sách vai trò ở trạng thái <b>Nháp</b> sẽ hiển thị ở đây.</div>
      </tab>
    </tabset>
  </div>
</div>

<!-- Modal chi tiết vai trò -->
<ng-template #detailModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-info-circle me-2"></i>Chi tiết vai trò
      <span *ngIf="selectedItem?.status" [ngClass]="getStatusBadgeClass(selectedItem?.status)" style="vertical-align: middle; font-size: 1em; font-weight: 500; margin-left: 8px;">
        {{ getStatusLabel(selectedItem?.status) }}
      </span>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="row gy-3">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Mã vai trò</label>
        <div class="text-dark ps-1">{{ selectedItem?.code }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tên vai trò</label>
        <div class="text-dark ps-1">{{ selectedItem?.name }}</div>
      </div>
      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Mô tả</label>
        <div class="text-dark ps-1">{{ selectedItem?.description || 'Không có' }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Trạng thái</label>
        <div class="text-dark ps-1">
          <span *ngIf="selectedItem?.status; else noStatus"
                [ngClass]="getStatusBadgeClass(selectedItem?.status)">
            {{ getStatusLabel(selectedItem?.status) }}
          </span>
          <ng-template #noStatus>
            <span class="badge badge-soft-light">Không xác định</span>
          </ng-template>
        </div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Người tạo</label>
        <div class="text-dark ps-1">{{ selectedItem?.requestedBy }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Ngày tạo</label>
        <div class="text-dark ps-1">{{ selectedItem?.requestedDate | date: 'dd/MM/yyyy HH:mm:ss' }}</div>
      </div>
      <div class="col-md-6" *ngIf="selectedItem?.status === 'Approved'">
        <label class="form-label fw-bold text-muted">Ngày duyệt</label>
        <div class="text-dark ps-1">{{ selectedItem?.approveDate | date: 'dd/MM/yyyy HH:mm:ss' }}</div>
      </div>
      <div *ngIf="selectedItem?.status === 'Rejected' && selectedItem?.rejectReason" class="alert alert-danger mt-3">
        <i class="fas fa-ban me-2"></i>
        ⛔ Yêu cầu trước đã bị từ chối bởi CHECKER lúc {{ selectedItem?.rejectedDate | date:'dd/MM/yyyy' }}<br>
        Lý do: {{ selectedItem?.rejectReason }}
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
  </div>
</ng-template>

<!-- Modal thêm mới vai trò -->
<ng-template #createModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-success fw-semibold">
        <i class="fas fa-plus-circle me-2"></i>Thêm mới vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.code.errors}"
                 appUpperNoSpace />
          <div *ngIf="submitted && roleForm.controls.code.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.code.errors.required">Mã vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.code.errors.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.name.errors}" />
          <div *ngIf="submitted && roleForm.controls.name.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors.required">Tên vai trò không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="2" placeholder="Nhập mô tả"></textarea>
        </div>
      </div>
      <div class="mt-3 small text-muted">
        <span *ngIf="currentUser">Tạo bởi: {{ currentUser.userName }} lúc {{ (now | date:'dd/MM/yyyy HH:mm') }}</span>
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      </div>
      <div>
        <button type="button" class="btn btn-outline-primary me-2" (click)="saveDraftRole()">
          <i class="fas fa-save me-1"></i> Lưu nháp
        </button>
        <button type="button" class="btn btn-primary" (click)="openSubmitConfirm()">
          <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
        </button>
      </div>
    </div>
  </form>
</ng-template>

<!-- Modal xác nhận gửi duyệt -->
<ng-template #submitConfirmModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-question-circle me-2"></i> Xác nhận gửi duyệt
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeSubmitConfirm()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div>Bạn có chắc chắn muốn gửi yêu cầu phê duyệt vai trò này không?</div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-secondary" (click)="closeSubmitConfirm()">Hủy</button>
    <button type="button" class="btn btn-primary" (click)="submitRoleForApproval()">Xác nhận</button>
  </div>
</ng-template>

<!-- Modal phê duyệt yêu cầu -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title text-success fw-semibold">
      <i class="fas fa-check-circle me-2"></i> Phê duyệt yêu cầu vai trò
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="row gy-3">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Mã vai trò</label>
        <div class="text-dark ps-1">{{ selectedItem?.code }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tên vai trò</label>
        <div class="text-dark ps-1">{{ selectedItem?.name }}</div>
      </div>

      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Mô tả</label>
        <div class="text-dark ps-1">{{ selectedItem?.description || 'Không có' }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tình trạng xử lý</label>
        <div class="text-dark ps-1">
          <span class="badge bg-success">Chờ duyệt thêm</span>
        </div>
      </div>

      <div class="col-md-6" *ngIf="selectedItem?.requestedDate">
        <label class="form-label fw-bold text-muted">Ngày yêu cầu</label>
        <div class="text-dark ps-1">{{ selectedItem?.requestedDate | date:'dd/MM/yyyy HH:mm:ss' }}</div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-success" (click)="approveRole()">
      <i class="fas fa-check me-1"></i> Duyệt yêu cầu
    </button>
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal từ chối yêu cầu -->
<ng-template #rejectModal>
  <form [formGroup]="rejectForm" (ngSubmit)="confirmRejectRole()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-times-circle me-2"></i> Từ chối yêu cầu
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="position-relative">
        <label class="form-label">Lý do từ chối</label>
        <textarea
          class="form-control"
          formControlName="reason"
          rows="3"
          placeholder="Nhập lý do từ chối..."
          [ngClass]="{'is-invalid': submittedReject && rejectForm.controls.reason.errors}">
        </textarea>
        <div *ngIf="submittedReject && rejectForm.controls.reason.errors" class="invalid-tooltip">
          <span *ngIf="rejectForm.controls.reason.errors.required">Lý do không được để trống</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-times me-1"></i> Xác nhận từ chối
      </button>
      <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
    </div>
  </form>
</ng-template>

<!-- Modal chỉnh sửa vai trò -->
<ng-template #editModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-warning fw-semibold">
        <i class="fas fa-pen me-2"></i>Chỉnh sửa vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.code.errors}"
                 appUpperNoSpace />
          <div *ngIf="submitted && roleForm.controls.code.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.code.errors.required">Mã vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.code.errors.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.name.errors}" />
          <div *ngIf="submitted && roleForm.controls.name.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors.required">Tên vai trò không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="2" placeholder="Nhập mô tả"></textarea>
        </div>
      </div>
      <div class="mt-3 small text-muted">
        <span *ngIf="currentUser">Tạo bởi: {{ currentUser.userName }} lúc {{ (selectedItem?.requestedDate | date:'dd/MM/yyyy HH:mm') }}</span>
      </div>
      <div *ngIf="rejectedReason" class="alert alert-danger mt-3">
        <i class="fas fa-ban me-2"></i>
        ⛔ Yêu cầu trước đã bị từ chối bởi CHECKER lúc {{ selectedItem?.rejectedDate | date:'dd/MM/yyyy' }}<br>
        Lý do: {{ rejectedReason }}
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button *ngIf="(selectedItem?.status || '').toUpperCase() === 'DRF'" type="button" class="btn btn-danger" (click)="openDeleteDraftModal()">
          <i class="fas fa-trash-alt me-1"></i> Xoá nháp
        </button>
      </div>
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
        <ng-container *ngIf="(selectedItem?.status || '').toUpperCase() === 'DRF'; else normalEditBtns">
          <button type="button" class="btn btn-outline-primary me-2" (click)="saveDraftRole()">
            <i class="fas fa-save me-1"></i> Lưu nháp
          </button>
          <button type="button" class="btn btn-primary" (click)="openSubmitConfirm()">
            <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
          </button>
        </ng-container>
        <ng-template #normalEditBtns>
          <button type="button" class="btn btn-warning" (click)="submitEditRoleForm()">
            <i class="fas fa-save me-1"></i> Lưu thay đổi
          </button>
        </ng-template>
      </div>
    </div>
  </form>
</ng-template>

<!-- Confirm modal trigger -->
<div *ngIf="showSubmitConfirm">
  <ng-container *ngTemplateOutlet="submitConfirmModal"></ng-container>
</div>

<!-- Modal xác nhận xóa -->
<ng-template #deleteModal>
  <div class="modal-header">
    <h5 class="modal-title text-danger fw-semibold">
      <i class="fas fa-trash-alt me-2"></i>Xác nhận xóa vai trò
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Bạn có chắc chắn muốn xóa vai trò này?
    </div>
    <div class="mt-3">
      <div class="mb-2">
        <span class="fw-bold text-muted">Mã vai trò:</span>
        <span class="ps-2">{{ selectedItem?.code }}</span>
      </div>
      <div class="mb-2">
        <span class="fw-bold text-muted">Tên vai trò:</span>
        <span class="ps-2">{{ selectedItem?.name }}</span>
      </div>
      <div class="mb-2">
        <span class="fw-bold text-muted">Mô tả:</span>
        <span class="ps-2">{{ selectedItem?.description || 'Không có' }}</span>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-danger" (click)="confirmDeleteRole()">
      <i class="fas fa-trash-alt me-1"></i> Xác nhận xóa
    </button>
    <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal xác nhận xóa nháp -->
<ng-template #deleteDraftModal>
  <div class="modal-header">
    <h5 class="modal-title text-danger fw-semibold">
      <i class="fas fa-trash-alt me-2"></i>Xác nhận xoá bản nháp
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Bạn có chắc chắn muốn xoá bản nháp này?
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-danger" (click)="confirmDeleteDraft()">
      <i class="fas fa-trash-alt me-1"></i> Xác nhận xoá
    </button>
    <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Enhanced Role Request Detail Modal -->
<ng-template #requestDetailModal>
  <div class="modal-header">
    <h5 class="modal-title fw-semibold">
      <i [class]="getRequestTypeIcon(requestDetailData?.requestType)" 
         [ngClass]="getRequestTypeColor(requestDetailData?.requestType)" 
         class="me-2"></i>
      Chi tiết yêu cầu vai trò
      <span *ngIf="requestDetailData?.requestType" 
            [ngClass]="getRequestTypeBadgeClass(requestDetailData?.requestType)" 
            class="badge ms-2">
        {{ getRequestTypeLabel(requestDetailData?.requestType) }}
      </span>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  
  <div class="modal-body px-4 py-3">
    <!-- Loading state -->
    <div *ngIf="isLoadingRequestDetail" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin chi tiết...</p>
    </div>

    <!-- Content when data is loaded -->
    <div *ngIf="!isLoadingRequestDetail && requestDetailData">
      <!-- Request Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
              </h6>
              <div class="row g-2">
                <div class="col-6">
                  <small class="text-muted">ID yêu cầu:</small>
                  <div class="fw-bold">{{ requestDetailData.requestId || '—' }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Người tạo:</small>
                  <div class="fw-bold">{{ requestDetailData.requestedBy || '—' }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Ngày tạo:</small>
                  <div class="fw-bold">{{ requestDetailData.requestedDate | date:'dd/MM/yyyy HH:mm:ss' }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Trạng thái:</small>
                  <div>
                    <span [ngClass]="getStatusBadgeClass(requestDetailData.status)">
                      {{ getStatusLabel(requestDetailData.status) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-tasks me-2"></i>Tóm tắt thay đổi
              </h6>
              <div class="changes-summary">
                <div *ngIf="requestDetailData.requestType === 'CREATE'" class="text-success">
                  <i class="fas fa-plus-circle me-1"></i>
                  <strong>Tạo mới vai trò:</strong> {{ requestDetailData.newData?.name || '—' }}
                </div>
                <div *ngIf="requestDetailData.requestType === 'UPDATE'" class="text-warning">
                  <i class="fas fa-edit me-1"></i>
                  <strong>Cập nhật vai trò:</strong> {{ requestDetailData.oldData?.name || '—' }}
                  <div class="small text-muted mt-1">
                    <span class="change-count">{{ getChangedFieldsCount() }}</span> trường thay đổi
                  </div>
                </div>
                <div *ngIf="requestDetailData.requestType === 'DELETE'" class="text-danger">
                  <i class="fas fa-trash-alt me-1"></i>
                  <strong>Xóa vai trò:</strong> {{ requestDetailData.oldData?.name || '—' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CREATE Request - Show new data only -->
      <div *ngIf="requestDetailData.requestType === 'CREATE'" class="card border-0">
        <div class="card-header bg-success bg-opacity-10 border-0">
          <h6 class="mb-0 text-success">
            <i class="fas fa-plus-circle me-2"></i>Dữ liệu mới sẽ được tạo
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Mã vai trò</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.newData, 'code') }}
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Tên vai trò</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.newData, 'name') }}
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold text-muted">Mô tả</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.newData, 'description') }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- UPDATE Request - Show comparison -->
      <div *ngIf="requestDetailData.requestType === 'UPDATE'" class="card border-0">
        <div class="card-header bg-warning bg-opacity-10 border-0">
          <h6 class="mb-0 text-warning">
            <i class="fas fa-edit me-2"></i>So sánh thay đổi
          </h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered comparison-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 25%">Trường dữ liệu</th>
                  <th style="width: 37.5%">Giá trị cũ</th>
                  <th style="width: 37.5%">Giá trị mới</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="fw-bold">Mã vai trò</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('code')}">
                    {{ getFieldValue(requestDetailData.oldData, 'code') }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('code')}">
                    {{ getFieldValue(requestDetailData.newData, 'code') }}
                  </td>
                </tr>
                <tr>
                  <td class="fw-bold">Tên vai trò</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('name')}">
                    {{ getFieldValue(requestDetailData.oldData, 'name') }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('name')}">
                    {{ getFieldValue(requestDetailData.newData, 'name') }}
                  </td>
                </tr>
                <tr>
                  <td class="fw-bold">Mô tả</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('description')}">
                    {{ getFieldValue(requestDetailData.oldData, 'description') }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('description')}">
                    {{ getFieldValue(requestDetailData.newData, 'description') }}
                  </td>
                </tr>
                <tr>
                  <td class="fw-bold">Trạng thái</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('status')}">
                    {{ getFieldDisplayValue(requestDetailData.oldData, 'status') }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('status')}">
                    {{ getFieldDisplayValue(requestDetailData.newData, 'status') }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- DELETE Request - Show data to be deleted -->
      <div *ngIf="requestDetailData.requestType === 'DELETE'" class="card border-0">
        <div class="card-header bg-danger bg-opacity-10 border-0">
          <h6 class="mb-0 text-danger">
            <i class="fas fa-trash-alt me-2"></i>Dữ liệu sẽ bị xóa
          </h6>
        </div>
        <div class="card-body">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Cảnh báo:</strong> Vai trò này sẽ bị xóa vĩnh viễn sau khi được phê duyệt.
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Mã vai trò</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.oldData, 'code') }}
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Tên vai trò</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.oldData, 'name') }}
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold text-muted">Mô tả</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded">
                {{ getFieldValue(requestDetailData.oldData, 'description') }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rejection reason if applicable -->
      <div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
        <i class="fas fa-ban me-2"></i>
        <strong>Lý do từ chối:</strong> {{ requestDetailData.rejectReason }}
        <div class="small text-muted mt-1">
          Từ chối bởi: {{ requestDetailData.rejectedBy || '—' }} 
          lúc {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy HH:mm:ss' }}
        </div>
      </div>
    </div>

    <!-- Error state -->
    <div *ngIf="!isLoadingRequestDetail && !requestDetailData" class="text-center py-4">
      <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
      <p class="mt-2 text-muted">Không thể tải thông tin chi tiết</p>
    </div>
  </div>

  <div class="modal-footer border-top-0">
    <!-- Action buttons based on request type and status -->
    <div class="d-flex justify-content-between w-100">
      <div>
        <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">
          <i class="fas fa-times me-1"></i> Đóng
        </button>
      </div>
      
      <div *ngIf="requestDetailData?.status === 'UNA'">
        <button type="button" class="btn btn-success me-2" (click)="approveRole()">
          <i class="fas fa-check me-1"></i> Phê duyệt
        </button>
        <button type="button" class="btn btn-danger" (click)="openRejectModal(selectedItem)">
          <i class="fas fa-times me-1"></i> Từ chối
        </button>
      </div>
    </div>
  </div>
</ng-template>


