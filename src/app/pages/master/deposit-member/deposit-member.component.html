<div class="container-fluid">
  <ng-template #depositInfo>
    <ul class="list-unstyled mb-0 small">
      <li class="mb-3">
        <div class="fw-600">Mã TVLK</div>
        <div class="text-muted">Mã thành viên lưu ký (duy nhất) theo quy định của VSD/Ngân hàng.</div>
      </li>
      <li class="mb-3">
        <div class="fw-600">Tên viết tắt</div>
        <div class="text-muted">Tên rút gọn để hiển thị bảng, báo cáo.</div>
      </li>
      <li class="mb-3">
        <div class="fw-600">Tên đầy đủ</div>
        <div class="text-muted">Tên pháp lý đầy đủ của thành viên lưu ký.</div>
      </li>
      <li>
        <div class="fw-600">BIC Code</div>
        <div class="text-muted">Mã SWIFT/BIC định danh ngân hàng khi thanh toán.</div>
      </li>
    </ul>
  </ng-template>

  <app-page-title
    title="Thành viên lưu ký"
    [breadcrumbItems]="breadCrumbItems"
    infoTitle="Gợi ý mô tả trường thông tin"
    [infoTemplate]="depositInfo">
  </app-page-title>

  <div class="bg-white rounded shadow-sm p-3 position-relative">
    <div class="d-flex align-items-center gap-2 mb-3"></div>
    <!-- Search -->
    <div class="row gx-3 mb-3 gy-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Mã TVLK</label>
        <input class="form-control" type="text" placeholder="Nhập mã..." [(ngModel)]="filter.depositCode">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Tên viết tắt</label>
        <input class="form-control" type="text" placeholder="Nhập tên viết tắt..." [(ngModel)]="filter.shortName">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Tên đầy đủ</label>
        <input class="form-control" type="text" placeholder="Nhập tên đầy đủ..." [(ngModel)]="filter.fullName">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">BIC Code</label>
        <input class="form-control" type="text" placeholder="Nhập BIC..." [(ngModel)]="filter.bicCode">
      </div>
      <div class="col-md-4">
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="onSearch()">
            <i class="bx bx-search-alt-2"></i> Tìm kiếm
          </button>
          <button class="btn btn-outline-secondary" (click)="openImportModal()" title="Nhập">
            <i class="bx bx-import"></i> Nhập
          </button>
        </div>
      </div>
    </div>
    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <div class="table-responsive table-header-primary">
      <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
        <thead>
          <tr>
            <th style="min-width: 140px">
              <button class="th-sort" (click)="onSort('depositCode')">
                Mã TVLK
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='depositCode' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='depositCode' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 200px">
              <button class="th-sort" (click)="onSort('shortName')">
                Tên viết tắt
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='shortName' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='shortName' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 320px">
              <button class="th-sort" (click)="onSort('fullName')">
                Tên đầy đủ
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='fullName' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='fullName' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 160px">
              <button class="th-sort" (click)="onSort('bicCode')">
                BIC Code
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='bicCode' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='bicCode' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
          </tr>
        </thead>

        <tbody *ngIf="loading">
          <tr *ngFor="let _ of [].constructor(skeleton.rows)">
            <td *ngFor="let w of skeleton.columns"><app-skeleton [width]="w" height="18px"></app-skeleton></td>
          </tr>
        </tbody>

        <tbody *ngIf="!loading && items.length">
          <tr *ngFor="let m of items">
            <td class="fw-500">{{ m.depositCode }}</td>
            <td>{{ m.shortName }}</td>
            <td>{{ m.fullName }}</td>
            <td>{{ m.bicCode }}</td>
          </tr>
        </tbody>

        <tbody *ngIf="!loading && !items.length">
          <tr>
            <td colspan="4" class="text-center text-muted">Không có dữ liệu.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <app-pagination
      [paginationState]="getPaginationState()"
      [pageSizeOptions]="[{value:10,label:'10'},{value:20,label:'20'},{value:50,label:'50'}]"
      (pageChanged)="onPageChange($event)"
      (pageSizeChanged)="onPageSizeChange($event)">
    </app-pagination>
  </div>
</div>

<!-- Import Modal -->
<ng-template #importModal>
  <div class="modal-header">
    <h5 class="modal-title">Nhập thành viên lưu ký</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeImportModal()"></button>
  </div>
  <div class="modal-body">
    <!-- Upload row -->
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label fw-bold text-muted">Tệp CSV</label>
        <div class="input-group">
          <input 
            type="file" 
            accept=".csv" 
            class="form-control d-none" 
            id="fileInput"
            (change)="onFileSelected($event)"
            #fileInput>
          <input 
            type="text" 
            class="form-control" 
            [value]="importForm.file?.name || 'Chưa chọn file'"
            readonly
            placeholder="Chọn file CSV...">
          <button class="btn btn-outline-secondary" type="button" (click)="fileInput.click()">
            <i class="bx bx-folder-open"></i> Chọn file
          </button>
        </div>
        <div *ngIf="importForm.file" class="mt-2">
          <small class="text-success" *ngIf="!importError">
            <i class="bx bx-check-circle"></i> 
            {{ importForm.file.name }} ({{ getFileSize(importForm.file.size) }})
          </small>
          <small class="text-info" *ngIf="importError">
            <i class="bx bx-info-circle"></i> 
            {{ importForm.file.name }} ({{ getFileSize(importForm.file.size) }}) - Cần kiểm tra lỗi
          </small>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold text-muted">Ngày hiệu lực <span class="text-danger">*</span></label>
        <div class="input-group">
          <span class="input-group-text"><i class="bx bx-calendar"></i></span>
          <input 
            type="text" 
            class="form-control" 
            bsDatepicker 
            [bsConfig]="bsConfig" 
            placeholder="dd/MM/yyyy" 
            [(ngModel)]="effectiveDate" 
            (bsValueChange)="onEffectiveDateChange($event)"
            readonly>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold text-muted">&nbsp;</label>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-primary flex-grow-1" (click)="submitImport()" [disabled]="!importForm.file || !importForm.effectiveDate || uploading || importError">
            <i class="bx bx-upload me-1" *ngIf="!uploading"></i>
            <span class="spinner-border spinner-border-sm me-1" *ngIf="uploading" role="status" aria-hidden="true"></span>
            <span *ngIf="!uploading">Tải lên</span>
            <span *ngIf="uploading">Đang xử lý...</span>
          </button>
          <button type="button" class="btn btn-outline-secondary" (click)="onDownloadTemplate()" title="Tải file mẫu">
            <i class="bx bx-download"></i>
          </button>
        </div>
      </div>
    </div>
    <small class="text-muted d-block mb-3">
      • File phải có header: DepositCode, ShortName, FullName, Address. Khuyến nghị encoding UTF-8.<br>
      • Định dạng hỗ trợ: CSV. Dung lượng tối đa: 10MB.
    </small>

    <!-- Staged File / Request Info -->
    <div class="mb-3" *ngIf="loadingStagedFile || stagedFileInfo">
      <div *ngIf="loadingStagedFile" class="d-flex align-items-center text-muted">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        <span>Đang kiểm tra file đã tải lên...</span>
      </div>
      
      <div *ngIf="stagedFileInfo && !loadingStagedFile" class="alert mb-0"
           [ngClass]="stagedFileInfo.isRequest ? 'alert-warning' : 'alert-info'">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div>
              <div *ngIf="stagedFileInfo.isRequest; else stagedInfo">
                <strong>Đang chờ duyệt yêu cầu nhập.</strong><br>
                <strong>File:</strong> {{ stagedFileInfo.fileName }}<br>
                <strong>Ngày hiệu lực:</strong> {{ stagedFileInfo.effectiveDate | date:'dd/MM/yyyy' }}
              </div>
              <ng-template #stagedInfo>
                <strong>File đã tải lên:</strong> {{ stagedFileInfo.fileName }}<br>
                <strong>Ngày hiệu lực:</strong> {{ stagedFileInfo.effectiveDate | date:'dd/MM/yyyy' }}
              </ng-template>
            </div>
          </div>
          <div *ngIf="stagedFileInfo.isRequest" class="d-flex gap-2">
            <button type="button" class="btn btn-success btn-sm" (click)="openApproveModal()">
              <i class="bx bx-check"></i> Duyệt
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" (click)="openRejectModal()">
              <i class="bx bx-x"></i> Từ chối
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="importError" class="alert alert-danger" [innerHTML]="importError"></div>

  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeImportModal()" [disabled]="uploading">Đóng</button>
  </div>
</ng-template>

<!-- Approve Confirm Modal -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title">Xác nhận duyệt yêu cầu</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeApproveModal()"></button>
  </div>
  <div class="modal-body">
    <p>Bạn có chắc chắn muốn duyệt yêu cầu nhập này?</p>
    <ul class="list-unstyled small text-muted mb-0" *ngIf="stagedFileInfo">
      <li><strong>File:</strong> {{ stagedFileInfo.fileName }}</li>
      <li><strong>Ngày hiệu lực:</strong> {{ stagedFileInfo.effectiveDate | date:'dd/MM/yyyy' }}</li>
    </ul>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeApproveModal()" [disabled]="approveLoading">Hủy</button>
    <button type="button" class="btn btn-success" (click)="approveConfirm()" [disabled]="approveLoading">
      <span class="spinner-border spinner-border-sm me-1" *ngIf="approveLoading" role="status" aria-hidden="true"></span>
      <span *ngIf="!approveLoading">Duyệt</span>
      <span *ngIf="approveLoading">Đang duyệt...</span>
    </button>
  </div>
 </ng-template>

<!-- Reject Reason Modal -->
<ng-template #rejectModal>
  <div class="modal-header">
    <h5 class="modal-title">Từ chối yêu cầu nhập</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeRejectModal()"></button>
  </div>
  <div class="modal-body">
    <label class="form-label fw-bold text-muted">Lý do từ chối</label>
    <textarea class="form-control" rows="4" [(ngModel)]="rejectReason" placeholder="Nhập lý do từ chối..."></textarea>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeRejectModal()">Hủy</button>
    <button type="button" class="btn btn-danger" (click)="confirmReject()" [disabled]="!rejectReason?.trim()">Từ chối</button>
  </div>
</ng-template>
