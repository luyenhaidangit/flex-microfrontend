<div class="container-fluid">
  <ng-template #depositInfo>
    <ul class="list-unstyled mb-0 small">
      <li class="mb-3">
        <div class="fw-600">Mã TVLK</div>
        <div class="text-muted">Mã thành viên lưu ký (duy nhất) theo quy định của VSD/Ngân hàng.</div>
      </li>
      <li class="mb-3">
        <div class="fw-600">Tên viết tắt</div>
        <div class="text-muted">Tên rút gọn để hiển thị bảng, báo cáo.</div>
      </li>
      <li class="mb-3">
        <div class="fw-600">Tên đầy đủ</div>
        <div class="text-muted">Tên pháp lý đầy đủ của thành viên lưu ký.</div>
      </li>
      <li>
        <div class="fw-600">BIC Code</div>
        <div class="text-muted">Mã SWIFT/BIC định danh ngân hàng khi thanh toán.</div>
      </li>
    </ul>
  </ng-template>

  <app-page-title
    title="Thành viên lưu ký"
    [breadcrumbItems]="breadCrumbItems"
    infoTitle="Gợi ý mô tả trường thông tin"
    [infoTemplate]="depositInfo">
  </app-page-title>

  <div class="bg-white rounded shadow-sm p-3 position-relative">
    <div class="d-flex align-items-center gap-2 mb-3"></div>
    <!-- Search -->
    <div class="row gx-3 mb-3 gy-2 align-items-end">
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Mã TVLK</label>
        <input class="form-control" type="text" placeholder="Nhập mã..." [(ngModel)]="filter.depositCode">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Tên viết tắt</label>
        <input class="form-control" type="text" placeholder="Nhập tên viết tắt..." [(ngModel)]="filter.shortName">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">Tên đầy đủ</label>
        <input class="form-control" type="text" placeholder="Nhập tên đầy đủ..." [(ngModel)]="filter.fullName">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold text-muted">BIC Code</label>
        <input class="form-control" type="text" placeholder="Nhập BIC..." [(ngModel)]="filter.bicCode">
      </div>
      <div class="col-md-4">
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-fill" (click)="onSearch()">
            <i class="bx bx-search-alt-2"></i> Tìm kiếm
          </button>
          <button class="btn btn-outline-secondary" (click)="openImportModal()" title="Nhập">
            <i class="bx bx-import"></i> Nhập
          </button>
        </div>
      </div>
    </div>
    <!-- Error -->
    <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

    <div class="table-responsive table-header-primary">
      <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
        <thead>
          <tr>
            <th style="min-width: 140px">
              <button class="th-sort" (click)="onSort('depositCode')">
                Mã TVLK
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='depositCode' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='depositCode' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 200px">
              <button class="th-sort" (click)="onSort('shortName')">
                Tên viết tắt
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='shortName' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='shortName' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 320px">
              <button class="th-sort" (click)="onSort('fullName')">
                Tên đầy đủ
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='fullName' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='fullName' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
            <th style="min-width: 160px">
              <button class="th-sort" (click)="onSort('bicCode')">
                BIC Code
                <i class="mdi" [ngClass]="{
                  'mdi-menu-up': sort.column==='bicCode' && sort.direction==='asc',
                  'mdi-menu-down': sort.column==='bicCode' && sort.direction==='desc'
                }"></i>
              </button>
            </th>
          </tr>
        </thead>

        <tbody *ngIf="loading">
          <tr *ngFor="let _ of [].constructor(skeleton.rows)">
            <td *ngFor="let w of skeleton.columns"><app-skeleton [width]="w" height="18px"></app-skeleton></td>
          </tr>
        </tbody>

        <tbody *ngIf="!loading && items.length">
          <tr *ngFor="let m of items">
            <td class="fw-500">{{ m.depositCode }}</td>
            <td>{{ m.shortName }}</td>
            <td>{{ m.fullName }}</td>
            <td>{{ m.bicCode }}</td>
          </tr>
        </tbody>

        <tbody *ngIf="!loading && !items.length">
          <tr>
            <td colspan="4" class="text-center text-muted">Không có dữ liệu.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <app-pagination
      [paginationState]="getPaginationState()"
      [pageSizeOptions]="[{value:10,label:'10'},{value:20,label:'20'},{value:50,label:'50'}]"
      (pageChanged)="onPageChange($event)"
      (pageSizeChanged)="onPageSizeChange($event)">
    </app-pagination>
  </div>
</div>

<!-- Import Modal -->
<ng-template #importModal>
  <div class="modal-header">
    <h5 class="modal-title">Nhập thành viên lưu ký</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeImportModal()"></button>
  </div>
  <div class="modal-body">
    <!-- Upload row -->
    <div class="row g-2 align-items-end mb-2">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tệp Excel/CSV</label>
        <input type="file" accept=".csv,.xlsx" class="form-control" (change)="onFileSelected($event)">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold text-muted">Ngày hiệu lực</label>
        <input type="text" class="form-control" bsDatepicker [bsConfig]="bsConfig" placeholder="dd/MM/yyyy" [(ngModel)]="effectiveDate" (bsValueChange)="onEffectiveDateChange($event)">
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button type="button" class="btn btn-primary flex-grow-1" (click)="submitImport()" [disabled]="!importForm.file || !importForm.effectiveDate || uploading">
          <i class="bx bx-upload"></i>
          <span *ngIf="!uploading">Upload</span>
          <span *ngIf="uploading">Đang xử lý...</span>
        </button>
        <button type="button" class="btn btn-outline-secondary" (click)="onDownloadTemplate()" title="Tải file mẫu">
          <i class="bx bx-download"></i>
        </button>
      </div>
    </div>
    <small class="text-muted d-block mb-3">
      • File phải có header: DepositCode, ShortName, FullName, Address. Khuyến nghị encoding UTF-8.
    </small>

    <div *ngIf="importError" class="alert alert-danger">{{ importError }}</div>

    <!-- Uploaded files list -->
    <div class="mt-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold">Danh sách file đã upload</div>
      </div>
      <div class="d-flex align-items-center gap-2 mb-2">
        <label class="small text-muted mb-0">Lọc theo trạng thái</label>
        <select class="form-select form-select-sm" style="width:auto" [(ngModel)]="importHistoryStatusFilter">
          <option value="All">Tất cả</option>
          <option value="Pending">Pending</option>
          <option value="Completed">Completed</option>
          <option value="Failed">Failed</option>
        </select>
      </div>
      <div class="table-responsive">
        <table class="table align-middle table-sm table-nowrap">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Ngày hiệu lực</th>
              <th>Ngày upload</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody *ngIf="importHistory?.length; else noUploads">
            <tr *ngFor="let f of importHistoryFiltered" [ngClass]="{'row-completed': f.status==='Completed'}" [attr.title]="'Checksum: ' + (f.checksum || '-') + ' | Người tải: ' + (f.uploader || '-') + ' | Records: ' + (f.recordCount ?? '-')">
              <td>{{ f.fileName }}</td>
              <td>{{ f.effectiveDate | date:'yyyy-MM-dd' }}</td>
              <td>{{ f.uploadDate | date:'yyyy-MM-dd HH:mm' }}</td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-warning text-dark': f.status==='Pending',
                  'bg-success': f.status==='Completed',
                  'bg-danger': f.status==='Failed'
                }">{{ f.status }}</span>
              </td>
              <td class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" (click)="previewUpload(f)">
                  <i class="bx bx-search-alt-2"></i> Xem
                </button>
                <button class="btn btn-sm btn-outline-secondary" (click)="replaceUpload(f)">
                  <i class="bx bx-edit"></i> Thay thế
                </button>
                <button class="btn btn-sm btn-outline-info" (click)="reupload(f)">
                  <i class="bx bx-upload"></i> Tải lại
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noUploads>
          <div class="text-muted small">Chưa có lần tải lên nào.</div>
        </ng-template>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" (click)="exportCurrentPreview()" [disabled]="!currentPreviewId">Xuất kết quả</button>
    <button type="button" class="btn btn-light" (click)="closeImportModal()" [disabled]="uploading">Đóng</button>
  </div>
</ng-template>

<!-- Preview Modal -->
<ng-template #previewModal>
  <div class="modal-header">
    <h5 class="modal-title">Xem trước kết quả</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closePreviewModal()"></button>
  </div>
  <div class="modal-body">
    <div *ngIf="previewError" class="alert alert-danger">{{ previewError }}</div>
    <div *ngIf="previewData as pv">
      <div class="mb-2 fw-bold">Tổng quan</div>
      <ul class="small mb-3">
        <li>Thêm mới: {{ pv.summary?.created || 0 }}</li>
        <li>Cập nhật: {{ pv.summary?.updated || 0 }}</li>
        <li>Ngừng hoạt động: {{ pv.summary?.deactivated || 0 }}</li>
      </ul>
      <div class="table-responsive" *ngIf="pv.items?.length">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>DepositCode</th>
              <th>ShortName (cũ → mới)</th>
              <th>FullName (cũ → mới)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of pv.items">
              <td>{{ it.depositCode }}</td>
              <td>{{ it.shortNameOld || '' }}<span *ngIf="it.shortNameOld"> → </span>{{ it.shortNameNew || '' }}</td>
              <td>{{ it.fullNameOld || '' }}<span *ngIf="it.fullNameOld"> → </span>{{ it.fullNameNew || '' }}</td>
              <td>{{ it.action }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="!pv.items?.length" class="text-muted small">Không có chi tiết thay đổi.</div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-light" (click)="closePreviewModal()">Đóng</button>
  </div>
</ng-template>