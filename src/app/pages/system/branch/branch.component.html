<div class="container-fluid">
  <app-page-title title="Quản lý chi nhánh" [breadcrumbItems]="breadCrumbItems">
  </app-page-title>

  <div class="bg-white rounded shadow-sm p-3">
    <tabset class="nav-pills nav-tabs mb-3">
      <!-- Approved tab -->
      <tab heading="Đã duyệt" (selectTab)="switchTab('approved')">
            <div class="row gx-3 mb-3 gy-2 align-items-end">
              <div class="col-md-4 mb-2 mb-md-0">
                <div class="form-group">
                  <label class="form-label fw-bold text-muted" for="keywordInput">Từ khóa tìm kiếm</label>
                  <input id="keywordInput" class="form-control" type="text" placeholder="Nhập từ khóa..."
                    [(ngModel)]="pagingState.keyword">
                </div>
              </div>
              <div class="col-md-3 mb-2 mb-md-0">
                <div class="form-group">
                  <label class="form-label fw-bold text-muted" for="statusSelect">Trạng thái</label>
                  <select id="statusSelect" class="form-select" [(ngModel)]="pagingState.isActive">
                    <option [ngValue]="null">Tất cả trạng thái</option>
                    <option [ngValue]="true">Hoạt động</option>
                    <option [ngValue]="false">Không hoạt động</option>
                  </select>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-group">
                  <label class="form-label d-block" style="visibility:hidden">Tìm kiếm</label>
                  <button class="btn btn-primary w-100" (click)="onSearch()">
                    <i class="bx bx-search-alt-2"></i> Tìm kiếm
                  </button>
                </div>
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-success fw-bold shadow-sm" (click)="openCreateModal()" style="min-width: 120px;">
                  <i class="fas fa-plus me-1"></i> Thêm mới
                </button>
              </div>
            </div>

        <!-- ============ TABLE ============ -->
        <div class="table-responsive">
          <!-- Skeleton -->
          <ng-container *ngIf="isLoading; else tableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã chi nhánh</th>
                  <th>Tên chi nhánh</th>
                  <th>Loại chi nhánh</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]">
                  <td><app-skeleton width="60px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="140px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="200px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="80px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="18px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <!-- Content -->
          <ng-template #tableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã chi nhánh</th>
                  <th>Tên chi nhánh</th>
                  <th>Loại chi nhánh</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of items;">
                  <td>{{ item.code | safeField }}</td>
                  <td>{{ item.name | safeField }}</td>
                  <td>{{ getBranchTypeLabel(item.branchType) | safeField }}</td>
                  <td>{{ item.description | safeField }}</td>
                  <td><app-badge [value]="item.isActive" type="status"></app-badge></td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <ng-container *ngIf="item.pendingAction === 'CREATE'">
                      <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                        <i class="fas fa-check"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                        <i class="fas fa-times"></i>
                      </span>
                    </ng-container>
                    <ng-container *ngIf="!item.pendingAction">
                      <span class="text-warning ms-2 pointer" tooltip="Chỉnh sửa" (click)="openEditModal(item)">
                        <i class="fas fa-edit"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Xoá" (click)="openDeleteModal(item)">
                        <i class="fas fa-trash"></i>
                      </span>
                    </ng-container>
                  </td>
                </tr>
                <tr *ngIf="items.length === 0">
                  <td colspan="6" class="text-center">Không có dữ liệu</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <!-- Pagination -->
        <div class="table-filter d-flex justify-content-between align-items-center mt-2">
          <ul class="pagination mb-0">
            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
              <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                <i class="mdi mdi-chevron-left"></i>
              </a>
            </li>

            <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                class="page-item cursor-pointer"
                [class.active]="pagingState.pageIndex === idx + 1">
              <a class="page-link" (click)="changePage(idx + 1)">
                {{ idx + 1 }}
              </a>
            </li>

            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
              <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                <i class="mdi mdi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <!-- page size -->
          <div class="per-page">
            Hiển thị
            <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
              <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                {{ opt.label }}
              </option>
            </select>
            / {{ pagingState.totalItems }} tổng số bản ghi
          </div>
        </div>
             </tab>
      <!-- Pending tab -->
      <tab heading="Chờ duyệt" (selectTab)="switchTab('pending')">
        <!-- Search form for pending tab -->
        <div class="row gx-3 mb-3 gy-2 align-items-end">
          <div class="col-md-4 mb-2 mb-md-0">
            <div class="form-group">
              <label class="form-label fw-bold text-muted" for="keywordInputPending">Từ khóa tìm kiếm</label>
              <input id="keywordInputPending" class="form-control" type="text" placeholder="Nhập từ khóa..."
                [(ngModel)]="pagingState.keyword">
            </div>
          </div>
          <div class="col-md-3 mb-2 mb-md-0">
            <div class="form-group">
              <label class="form-label fw-bold text-muted" for="requestTypeSelectPending">Loại yêu cầu</label>
              <select id="requestTypeSelectPending" class="form-select" [(ngModel)]="pagingState.type">
                <option [ngValue]="null">Tất cả loại yêu cầu</option>
                <option [ngValue]="'CREATE'">Tạo mới</option>
                <option [ngValue]="'UPDATE'">Cập nhật</option>
                <option [ngValue]="'DELETE'">Xóa</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="form-group">
              <label class="form-label d-block" style="visibility:hidden">Tìm kiếm</label>
              <button class="btn btn-primary w-100" (click)="onSearch()">
                <i class="bx bx-search-alt-2"></i> Tìm kiếm
              </button>
            </div>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-success fw-bold shadow-sm" (click)="openCreateModal()" style="min-width: 120px;">
              <i class="fas fa-plus me-1"></i> Thêm mới
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <ng-container *ngIf="isLoading; else pendingTableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã chi nhánh</th>
                  <th>Tên chi nhánh</th>
                  <th>Địa chỉ</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]">
                  <td><app-skeleton width="60px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="140px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="200px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="90px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="90px" height="18px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="18px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <ng-template #pendingTableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã chi nhánh</th>
                  <th>Tên chi nhánh</th>
                  <th>Địa chỉ</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of pendingItems;">
                  <td>{{ item.code | safeField }}</td>
                  <td>{{ item.name | safeField }}</td>
                  <td>{{ item.address | safeField }}</td>
                  <td>
                    <app-badge [value]="item.requestType" type="request"></app-badge>
                  </td>
                  <td>{{ item.requestedBy | safeField }}</td>
                  <td>{{ item.requestedDate | date: 'dd/MM/yyyy' }}</td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openRequestDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                      <i class="fas fa-check"></i>
                    </span>
                    <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                      <i class="fas fa-times"></i>
                    </span>
                  </td>
                </tr>
                <tr *ngIf="pendingItems.length === 0">
                  <td colspan="7" class="text-center">Không có yêu cầu chờ duyệt</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <!-- ============ PAGINATION FOR PENDING TAB ============ -->
        <div class="table-filter d-flex justify-content-between align-items-center mt-2">
          <ul class="pagination mb-0">
            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
              <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                <i class="mdi mdi-chevron-left"></i>
              </a>
            </li>

            <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                class="page-item cursor-pointer"
                [class.active]="pagingState.pageIndex === idx + 1">
              <a class="page-link" (click)="changePage(idx + 1)">
                {{ idx + 1 }}
              </a>
            </li>

            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
              <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                <i class="mdi mdi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <!-- page size -->
          <div class="per-page">
            Hiển thị
            <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
              <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                {{ opt.label }}
              </option>
            </select>
            / {{ pagingState.totalItems }} tổng số bản ghi
          </div>
        </div>
      </tab>
    </tabset>
  </div>
</div>

<!-- Detail Modal -->
<ng-template #detailModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-info-circle me-2"></i>Chi tiết chi nhánh
      <app-badge *ngIf="selectedItem?.status" [value]="selectedItem?.status" type="status"></app-badge>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="row gy-2">
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Mã chi nhánh</label>
        <div class="text-dark ps-1">{{ selectedItem?.code | safeField }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Tên chi nhánh</label>
        <div class="text-dark ps-1">{{ selectedItem?.name | safeField }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Loại chi nhánh</label>
        <div class="text-dark ps-1">{{ getBranchTypeLabel(selectedItem?.branchType) | safeField }}</div>
      </div>
      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Mô tả</label>
        <div class="text-dark ps-1">{{ selectedItem?.description | safeField }}</div>
      </div>
      <div class="col-md-12">
        <label class="form-label fw-bold text-muted">Địa chỉ</label>
        <div class="text-dark ps-1">{{ selectedItem?.address | safeField }}</div>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold text-muted">Trạng thái</label>
        <div class="text-dark ps-1">
          <app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
  </div>
</ng-template>

<!-- Create Modal -->
<ng-template #createModal>
  <form [formGroup]="branchForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-success fw-semibold">
        <i class="fas fa-plus-circle me-2"></i>Thêm mới chi nhánh
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã chi nhánh <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã chi nhánh"
                 [ngClass]="{'is-invalid': branchForm.controls.code.touched && branchForm.controls.code.invalid}"
                 appUpperNoSpace />
          <div *ngIf="branchForm.controls.code.touched && branchForm.controls.code.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.code.errors?.required">Mã chi nhánh không được để trống</span>
            <span *ngIf="branchForm.controls.code.errors?.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên chi nhánh <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên chi nhánh"
                 [ngClass]="{'is-invalid': branchForm.controls.name.touched && branchForm.controls.name.invalid}" />
          <div *ngIf="branchForm.controls.name.touched && branchForm.controls.name.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.name.errors?.required">Tên chi nhánh không được để trống</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Loại chi nhánh <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="branchType"
                  [ngClass]="{'is-invalid': branchForm.controls.branchType.touched && branchForm.controls.branchType.invalid}">
            <option [ngValue]="1">Chi nhánh chính</option>
            <option [ngValue]="2">Chi nhánh phụ</option>
            <option [ngValue]="3">Văn phòng đại diện</option>
          </select>
          <div *ngIf="branchForm.controls.branchType.touched && branchForm.controls.branchType.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.branchType.errors?.required">Loại chi nhánh không được để trống</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="isActive"
                  [ngClass]="{'is-invalid': branchForm.controls.isActive.touched && branchForm.controls.isActive.invalid}">
            <option [ngValue]="true">Hoạt động</option>
            <option [ngValue]="false">Không hoạt động</option>
          </select>
          <div *ngIf="branchForm.controls.isActive.touched && branchForm.controls.isActive.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.isActive.errors?.required">Trạng thái không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="3" 
                    placeholder="Nhập mô tả chi nhánh"
                    [ngClass]="{'is-invalid': branchForm.controls.description.touched && branchForm.controls.description.invalid}"></textarea>
          <div *ngIf="branchForm.controls.description.touched && branchForm.controls.description.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.description.errors?.maxlength">Mô tả không được vượt quá 500 ký tự</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Địa chỉ</label>
          <textarea class="form-control" formControlName="address" rows="2" placeholder="Nhập địa chỉ"></textarea>
        </div>
        <!-- Hidden fields for Create modal -->
        <input type="hidden" formControlName="comment" value="">
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      </div>
      <div>
        <button type="button" class="btn btn-primary" (click)="onSubmitBranch()">
          <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
        </button>
      </div>
    </div>
  </form>
</ng-template>

<!-- Edit Modal -->
<ng-template #editModal>
  <form [formGroup]="branchForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-primary fw-semibold">
        <i class="fas fa-edit me-2"></i>Tạo yêu cầu cập nhật chi nhánh
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên chi nhánh <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên chi nhánh mới"
            [ngClass]="{'is-invalid': branchForm.controls.name.touched && branchForm.controls.name.invalid}" />
          <div *ngIf="branchForm.controls.name.touched && branchForm.controls.name.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.name.errors?.required">Tên chi nhánh không được để trống</span>
            <span *ngIf="branchForm.controls.name.errors?.maxlength">Tên chi nhánh không được vượt quá 100 ký tự</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Loại chi nhánh <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="branchType"
                  [ngClass]="{'is-invalid': branchForm.controls.branchType.touched && branchForm.controls.branchType.invalid}">
            <option [ngValue]="1">Chi nhánh chính</option>
            <option [ngValue]="2">Chi nhánh phụ</option>
            <option [ngValue]="3">Văn phòng đại diện</option>
          </select>
          <div *ngIf="branchForm.controls.branchType.touched && branchForm.controls.branchType.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.branchType.errors?.required">Loại chi nhánh không được để trống</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
          <select class="form-select" formControlName="isActive"
                  [ngClass]="{'is-invalid': branchForm.controls.isActive.touched && branchForm.controls.isActive.invalid}">
            <option [ngValue]="true">Hoạt động</option>
            <option [ngValue]="false">Không hoạt động</option>
          </select>
          <div *ngIf="branchForm.controls.isActive.touched && branchForm.controls.isActive.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.isActive.errors?.required">Trạng thái không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="3" 
                    placeholder="Nhập mô tả chi nhánh mới"
                    [ngClass]="{'is-invalid': branchForm.controls.description.touched && branchForm.controls.description.invalid}"></textarea>
          <div *ngIf="branchForm.controls.description.touched && branchForm.controls.description.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.description.errors?.maxlength">Mô tả không được vượt quá 500 ký tự</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Địa chỉ</label>
          <textarea class="form-control" formControlName="address" rows="3" 
                    placeholder="Nhập địa chỉ mới (tối đa 500 ký tự)"
                    [ngClass]="{'is-invalid': branchForm.controls.address.touched && branchForm.controls.address.invalid}"></textarea>
          <div *ngIf="branchForm.controls.address.touched && branchForm.controls.address.invalid" class="invalid-tooltip">
            <span *ngIf="branchForm.controls.address.errors?.maxlength">Địa chỉ không được vượt quá 500 ký tự</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Lý do cập nhật</label>
          <textarea class="form-control" formControlName="comment" rows="3" placeholder="Nhập lý do cập nhật chi nhánh (tối đa 500 ký tự)"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      <button type="button" class="btn btn-primary" (click)="submitEditBranchForm()">
        <i class="fas fa-paper-plane me-1"></i> Gửi yêu cầu cập nhật
      </button>
    </div>
  </form>
</ng-template>

<!-- Delete Modal -->
<ng-template #deleteModal>
  <form [formGroup]="deleteForm" (ngSubmit)="confirmDeleteBranch()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-trash-alt me-2"></i>Gửi yêu cầu xóa chi nhánh
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <!-- Branch Information -->
      <div class="card border-0 bg-light mb-3">
        <div class="card-body">
          <h6 class="card-title text-muted mb-3">
            <i class="fas fa-info-circle me-2"></i>Thông tin chi nhánh sẽ xóa
          </h6>
          <div class="row g-2">
            <div class="col-md-6">
              <small class="text-muted">Mã chi nhánh:</small>
              <div class="fw-bold">{{ selectedItem?.code }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted">Tên chi nhánh:</small>
              <div class="fw-bold">{{ selectedItem?.name }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted">Trạng thái:</small>
              <div class="fw-bold">
                <app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
              </div>
            </div>
            <div class="col-md-12">
              <small class="text-muted">Địa chỉ:</small>
              <div class="fw-bold">{{ selectedItem?.address || 'Không có địa chỉ' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Reason Form -->
      <div class="position-relative">
        <label class="form-label">Lý do xóa</label>
        <textarea class="form-control" formControlName="comment" rows="3"
          placeholder="Nhập lý do xóa chi nhánh (tối đa 500 ký tự)"
          [ngClass]="{'is-invalid': deleteForm.controls.comment.touched && deleteForm.controls.comment.invalid}">
        </textarea>
        <div *ngIf="deleteForm.controls.comment.touched && deleteForm.controls.comment.invalid" class="invalid-tooltip">
          <span *ngIf="deleteForm.controls.comment.errors?.required">Lý do xóa không được để trống</span>
          <span *ngIf="deleteForm.controls.comment.errors?.maxlength">Lý do xóa không được vượt quá 500 ký tự</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-paper-plane me-1"></i>
        Gửi yêu cầu xóa
      </button>
    </div>
  </form>
</ng-template>

<!-- Modal phê duyệt yêu cầu -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title text-success fw-semibold">
      <i class="fas fa-check-circle me-2"></i> Xác nhận duyệt yêu cầu
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="card-title text-muted mb-3">
          <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
        </h6>
        <div class="row g-2">
          <div class="col-6">
            <small class="text-muted">ID yêu cầu:</small>
            <div class="fw-bold">{{ selectedItem?.requestId || selectedItem?.id }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Người tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedBy }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Ngày tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedDate | date:'dd/MM/yyyy' }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Loại yêu cầu:</small>
            <div class="fw-bold">
              <app-badge [value]="selectedItem?.requestType" type="request"></app-badge>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-success" (click)="approveBranch()">Xác nhận</button>
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal từ chối yêu cầu -->
<ng-template #rejectModal>
  <form [formGroup]="rejectForm" (ngSubmit)="confirmRejectBranch()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-times-circle me-2"></i> Từ chối yêu cầu
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="position-relative">
        <label class="form-label">Lý do từ chối</label>
        <textarea
          class="form-control"
          formControlName="reason"
          rows="3"
          placeholder="Nhập lý do từ chối..."
          [ngClass]="{'is-invalid': rejectForm.controls.reason.touched && rejectForm.controls.reason.invalid}">
        </textarea>
        <div *ngIf="rejectForm.controls.reason.touched && rejectForm.controls.reason.invalid" class="invalid-tooltip">
          <span *ngIf="rejectForm.controls.reason.errors?.required">Lý do không được để trống</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-times me-1"></i>
        Xác nhận từ chối
      </button>
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Hủy</button>
    </div>
  </form>
</ng-template>

<!-- Enhanced Branch Request Detail Modal -->
<ng-template #requestDetailModal>
  <div class="modal-header">
    <h5 class="modal-title fw-semibold">
      <i [class]="getRequestTypeIcon(getRequestType())" 
         [ngClass]="getRequestTypeColor(getRequestType())" 
         class="me-2"></i>
      Chi tiết yêu cầu chi nhánh
      <span *ngIf="getRequestType()" 
            [ngClass]="getRequestTypeBadgeClass(getRequestType())" 
            class="badge ms-2">
        {{ getRequestTypeLabel(getRequestType()) }}
      </span>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  
  <div class="modal-body px-4 py-3">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin chi tiết...</p>
    </div>

    <!-- Content when data is loaded -->
    <div *ngIf="!isLoading && requestDetailData">
      <!-- Request Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
              </h6>
              <div class="row g-2">
                <div class="col-6">
                  <small class="text-muted">ID yêu cầu:</small>
                  <div class="fw-bold">{{ requestDetailData.requestId | safeField }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Người tạo:</small>
                  <div class="fw-bold">{{ getCreatedBy() | safeField }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Ngày tạo:</small>
                  <div class="fw-bold">{{ getCreatedDate() | date:'dd/MM/yyyy' }}</div>
                </div>
                <div class="col-6">
                  <small class="text-muted">Loại yêu cầu:</small>
                  <div class="fw-bold">{{ getRequestTypeLabel(getRequestType()) }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-tasks me-2"></i>Tóm tắt thay đổi
              </h6>
              <div class="changes-summary">
                <div *ngIf="getRequestType() === 'CREATE'" class="text-success">
                  <i class="fas fa-plus-circle me-1"></i>
                  <strong>Tạo mới chi nhánh:</strong> {{ getBranchName(requestDetailData.newData) }}
                </div>
                <div *ngIf="getRequestType() === 'UPDATE'" class="text-warning">
                  <i class="fas fa-edit me-1"></i>
                  <strong>Cập nhật chi nhánh:</strong> {{ getBranchName(requestDetailData.oldData) }}
                  <div class="small text-muted mt-1">
                    <span class="change-count">Có thay đổi</span>
                  </div>
                </div>
                <div *ngIf="getRequestType() === 'DELETE'" class="text-danger">
                  <i class="fas fa-trash-alt me-1"></i>
                  <strong>Xóa chi nhánh:</strong> {{ getBranchName(requestDetailData.oldData) }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CREATE Request - Show new data only -->
      <div *ngIf="getRequestType() === 'CREATE'" class="card border-0">
        <div class="card-header bg-success bg-opacity-10 border-0">
          <h6 class="mb-0 text-success">
            <i class="fas fa-plus-circle me-2"></i>Dữ liệu mới sẽ được tạo
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Mã chi nhánh</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                {{ getBranchCode(requestDetailData.newData) | safeField }}
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Tên chi nhánh</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                {{ getBranchName(requestDetailData.newData) | safeField }}
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold text-muted">Địa chỉ</label>
              <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                {{ getBranchAddress(requestDetailData.newData) | safeField }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- UPDATE Request - Show comparison -->
      <div *ngIf="getRequestType() === 'UPDATE'" class="card border-0">
        <div class="card-header bg-warning bg-opacity-10 border-0">
          <h6 class="mb-0 text-warning">
            <i class="fas fa-edit me-2"></i>So sánh thay đổi
          </h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered comparison-table">
              <thead class="table-light">
                <tr>
                  <th style="width: 25%">Trường dữ liệu</th>
                  <th style="width: 37.5%">Giá trị cũ</th>
                  <th style="width: 37.5%">Giá trị mới</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="fw-bold">Mã chi nhánh</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('branchCode')}">
                    {{ getBranchCode(requestDetailData.oldData) }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('branchCode')}">
                    {{ getBranchCode(requestDetailData.newData) }}
                  </td>
                </tr>
                <tr>
                  <td class="fw-bold">Tên chi nhánh</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('branchName')}">
                    {{ getBranchName(requestDetailData.oldData) }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('branchName')}">
                    {{ getBranchName(requestDetailData.newData) }}
                  </td>
                </tr>
                <tr>
                  <td class="fw-bold">Địa chỉ</td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('address')}">
                    {{ getBranchAddress(requestDetailData.oldData) }}
                  </td>
                  <td [ngClass]="{'bg-light-warning': hasChanges('address')}">
                    {{ getBranchAddress(requestDetailData.newData) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- DELETE Request - Show data to be deleted -->
      <div *ngIf="getRequestType() === 'DELETE'" class="card border-0">
        <div class="card-header bg-danger bg-opacity-10 border-0">
          <h6 class="mb-0 text-danger">
            <i class="fas fa-trash-alt me-2"></i>Dữ liệu sẽ bị xóa
          </h6>
        </div>
        <div class="card-body">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Cảnh báo:</strong> Chi nhánh này sẽ bị xóa vĩnh viễn sau khi được phê duyệt.
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Mã chi nhánh</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                {{ getBranchCode(requestDetailData.oldData) | safeField }}
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold text-muted">Tên chi nhánh</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                {{ getBranchName(requestDetailData.oldData) | safeField }}
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold text-muted">Địa chỉ</label>
              <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                {{ getBranchAddress(requestDetailData.oldData) | safeField }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rejection reason if applicable -->
      <div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
        <i class="fas fa-ban me-2"></i>
        <strong>Lý do từ chối:</strong> {{ requestDetailData.rejectReason }}
        <div class="small text-muted mt-1">
          Từ chối bởi: {{ requestDetailData.rejectedBy | safeField }} 
          lúc {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy' }}
        </div>
      </div>
    </div>

    <!-- Error state -->
    <div *ngIf="!isLoading && !requestDetailData" class="text-center py-4">
      <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
      <p class="mt-2 text-muted">Không thể tải thông tin chi tiết</p>
    </div>
  </div>

  <div class="modal-footer border-top-0">
    <div class="d-flex justify-content-between w-100">
      <div>
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()" [disabled]="isApproving || isRejecting">
          <i class="fas fa-times me-1"></i> Đóng
        </button>
      </div>
      <div class="btn-group-approve-reject">
        <button type="button" class="btn btn-success me-2" (click)="approveBranch()">
            Duyệt
        </button>
        <button type="button" class="btn btn-danger" (click)="openRejectModal()">
          <i class="fas fa-times me-1"></i> Từ chối
        </button>
      </div>
    </div>
  </div>
</ng-template>