<div class="container-fluid">
  <app-page-title title="Quản lý vai trò" [breadcrumbItems]="breadCrumbItems">
  </app-page-title>
  <div class="role-header sticky-top bg-white p-3 mb-3" style="z-index: 10;">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
      <div class="flex-grow-1"></div>
      <div class="d-flex gap-2 ms-auto">
        <button type="button" class="btn btn-success fw-bold shadow-sm" (click)="openCreateModal()" style="min-width: 120px;">
          <i class="fas fa-plus me-1"></i> Thêm mới
        </button>
        <button type="button" class="btn btn-outline-secondary">
          <i class="fas fa-file-export me-1"></i> Xuất
        </button>
      </div>
    </div>
    <div class="row gx-3 gy-2 align-items-end">
      <div class="col-md-4 mb-2 mb-md-0">
        <div class="form-group">
          <label class="form-label fw-bold text-muted" for="keywordInput">Từ khóa tìm kiếm</label>
          <input id="keywordInput" class="form-control" type="text" placeholder="Nhập từ khóa..." [(ngModel)]="pagingState.keyword">
        </div>
      </div>
      <div class="col-md-3 mb-2 mb-md-0">
        <div class="form-group">
          <label class="form-label fw-bold text-muted" for="statusSelect">Trạng thái</label>
          <select id="statusSelect" class="form-select" [(ngModel)]="pagingState.isActive">
            <option [ngValue]="null">Tất cả trạng thái</option>
            <option [ngValue]="true">Hoạt động</option>
            <option [ngValue]="false">Không hoạt động</option>
          </select>
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group">
          <label class="form-label d-block" style="visibility:hidden">Tìm kiếm</label>
          <button class="btn btn-primary w-100" (click)="onSearch()">
            <i class="bx bx-search-alt-2"></i> Tìm kiếm
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded shadow-sm p-3">
    <tabset class="nav-pills nav-tabs mb-3">
      <!-- Approved tab -->
      <tab heading="Đã duyệt" (selectTab)="switchTab('approved')">
        <!-- ============ TABLE ============ -->
        <div class="table-responsive">
          <!-- Skeleton -->
          <ng-container *ngIf="isLoading; else tableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5]">
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="180px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="60px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <!-- Content -->
          <ng-template #tableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of items;">
                  <td>{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.description }}</td>
                  <td><app-badge [value]="item.isActive" type="status"></app-badge></td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <ng-container *ngIf="item.pendingAction === 'CREATE'">
                      <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                        <i class="fas fa-check"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                        <i class="fas fa-times"></i>
                      </span>
                    </ng-container>
                    <ng-container *ngIf="!item.pendingAction">
                      <span class="text-warning ms-2 pointer" tooltip="Chỉnh sửa" (click)="openEditModal(item)">
                        <i class="fas fa-pen"></i>
                      </span>
                      <span class="text-danger ms-2 pointer" tooltip="Xoá" (click)="openDeleteModal(item)">
                        <i class="fas fa-trash"></i>
                      </span>
                    </ng-container>
                  </td>
                </tr>
                <tr *ngIf="items.length === 0">
                  <td colspan="5" class="text-center">Không có dữ liệu</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <!-- Pagination -->
        <div class="table-filter d-flex justify-content-between align-items-center mt-2">
          <ul class="pagination mb-0">
            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
              <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                <i class="mdi mdi-chevron-left"></i>
              </a>
            </li>

            <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                class="page-item cursor-pointer"
                [class.active]="pagingState.pageIndex === idx + 1">
              <a class="page-link" (click)="changePage(idx + 1)">
                {{ idx + 1 }}
              </a>
            </li>

            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
              <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                <i class="mdi mdi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <!-- page size -->
          <div class="per-page">
            Hiển thị
            <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
              <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                {{ opt.label }}
              </option>
            </select>
            / {{ pagingState.totalItems }} tổng số bản ghi
          </div>
        </div>
      </tab>
      <!-- Pending tab -->
      <tab heading="Chờ duyệt" (selectTab)="switchTab('pending')">
        <div class="table-responsive">
          <ng-container *ngIf="isLoading; else pendingTableContent">
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of [1,2,3,4,5]">
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="120px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="180px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="80px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                  <td><app-skeleton width="100px" height="20px"></app-skeleton></td>
                </tr>
              </tbody>
            </table>
          </ng-container>
          <ng-template #pendingTableContent>
            <table class="table align-middle table-nowrap dt-responsive nowrap w-100">
              <thead>
                <tr>
                  <th>Mã vai trò</th>
                  <th>Tên vai trò</th>
                  <th>Mô tả</th>
                  <th>Loại yêu cầu</th>
                  <th>Người tạo</th>
                  <th>Ngày tạo</th>
                  <th>Ngày duyệt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of pendingItems;">
                  <td>{{ item.code }}</td>
                  <td>{{ item.name }}</td>
                  <td>{{ item.description }}</td>
                  <td>
                    <app-badge [value]="item.requestType" type="request"></app-badge>
                  </td>
                  <td>{{ item.requestedBy }}</td>
                  <td>{{ item.requestedDate | date: 'dd/MM/yyyy' }}</td>
                  <td>
                    <ng-container *ngIf="item.status === 'APPROVED'; else noApproveDate">
                      {{ item.approveDate | date: 'dd/MM/yyyy HH:mm:ss' }}
                    </ng-container>
                    <ng-template #noApproveDate>—</ng-template>
                  </td>
                  <td class="action-column">
                    <span class="text-info pointer" tooltip="Xem chi tiết" (click)="openRequestDetailModal(item)">
                      <i class="fas fa-eye"></i>
                    </span>
                    <span class="text-success ms-2 pointer" tooltip="Phê duyệt yêu cầu" (click)="openApproveModal(item)">
                      <i class="fas fa-check"></i>
                    </span>
                    <span class="text-danger ms-2 pointer" tooltip="Từ chối yêu cầu" (click)="openRejectModal(item)">
                      <i class="fas fa-times"></i>
                    </span>
                  </td>
                </tr>
                <tr *ngIf="pendingItems.length === 0">
                  <td colspan="8" class="text-center">Không có yêu cầu chờ duyệt</td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <!-- ============ PAGINATION FOR PENDING TAB ============ -->
        <div class="table-filter d-flex justify-content-between align-items-center mt-2">
          <ul class="pagination mb-0">
            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === 1">
              <a class="page-link" (click)="changePage(pagingState.pageIndex - 1)">
                <i class="mdi mdi-chevron-left"></i>
              </a>
            </li>

            <li *ngFor="let _ of [].constructor(pagingState.totalPages); let idx = index"
                class="page-item cursor-pointer"
                [class.active]="pagingState.pageIndex === idx + 1">
              <a class="page-link" (click)="changePage(idx + 1)">
                {{ idx + 1 }}
              </a>
            </li>

            <li class="page-item cursor-pointer" [class.disabled]="pagingState.pageIndex === pagingState.totalPages">
              <a class="page-link" (click)="changePage(pagingState.pageIndex + 1)">
                <i class="mdi mdi-chevron-right"></i>
              </a>
            </li>
          </ul>

          <!-- page size -->
          <div class="per-page">
            Hiển thị
            <select class="mx-1 cursor-pointer" [(ngModel)]="pagingState.pageSize" (change)="changePageSize()">
              <option *ngFor="let opt of DEFAULT_PER_PAGE_OPTIONS" [ngValue]="opt.value" class="cursor-pointer">
                {{ opt.label }}
              </option>
            </select>
            / {{ pagingState.totalItems }} tổng số bản ghi
          </div>
        </div>
      </tab>
    </tabset>
  </div>
</div>

<!-- Detail Modal -->
<ng-template #detailModal>
  <div class="modal-header">
    <h5 class="modal-title text-primary fw-semibold">
      <i class="fas fa-info-circle me-2"></i>Chi tiết vai trò
      <app-badge *ngIf="selectedItem?.status" [value]="selectedItem?.status" type="roleStatus" [tooltip]="getStatusTooltip(selectedItem?.status)"></app-badge>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <tabset>
      <tab heading="Thông tin">
        <div class="row gy-2 mt-3">
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Mã vai trò</label>
            <div class="text-dark ps-1">{{ selectedItem?.code || '—' }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Tên vai trò</label>
            <div class="text-dark ps-1">{{ selectedItem?.name || '—' }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Mô tả</label>
            <div class="text-dark ps-1">{{ selectedItem?.description || '—' }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold text-muted">Trạng thái</label>
            <div class="text-dark ps-1">
              <app-badge [value]="selectedItem?.isActive" type="status"></app-badge>
            </div>
          </div>
          <div class="col-md-12" *ngIf="selectedItem?.permissions?.length">
            <label class="form-label fw-bold text-muted">Quyền hạn</label>
            <div class="text-dark ps-1">
              <ng-container *ngFor="let perm of selectedItem.permissions">
                <span class="badge bg-secondary me-1">{{ perm }}</span>
              </ng-container>
            </div>
          </div>
          <div *ngIf="selectedItem?.status === 'REJECTED' && selectedItem?.rejectReason" class="alert alert-danger mt-3">
            <i class="fas fa-ban me-2"></i>
            <strong>Lý do từ chối:</strong> {{ selectedItem?.rejectReason }}
            <div class="small text-muted mt-1">
              Từ chối bởi: {{ selectedItem?.rejectedBy || '—' }} lúc {{ selectedItem?.rejectedDate | date:'dd/MM/yyyy' }}
            </div>
          </div>
        </div>
      </tab>
                      <tab heading="Lịch sử thay đổi" (selectTab)="loadChangeHistory()">
                  <div class="mt-3">
                    <!-- Loading state -->
                    <div *ngIf="isLoading" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                      </div>
                      <p class="mt-2 text-muted">Đang tải lịch sử thay đổi...</p>
                    </div>

                    <!-- History content -->
                    <div *ngIf="!isLoading">
            <div *ngIf="changeHistory?.length; else noHistory">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 40px;"></th> <!-- New column for expand/collapse icon -->
                      <th>Thông tin thay đổi</th>
                      <th>Thông tin duyệt</th>
                      <th>Trạng thái</th>
                      <th>Mô tả thay đổi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <ng-container *ngFor="let history of changeHistory; let i = index">
                      <!-- Main row -->
                      <tr class="cursor-pointer" 
                          (click)="toggleRowExpansion(i)"
                          [class.table-active]="isRowExpanded(i)">
                        <td class="text-center">
                          <i class="fas" 
                             [class.fa-chevron-down]="isRowExpanded(i)"
                             [class.fa-chevron-right]="!isRowExpanded(i)"
                             [class.text-primary]="isRowExpanded(i)"></i>
                        </td>
                        <td>
                          <div class="fw-bold">{{ history.timestamp | date:'dd/MM/yyyy' }}</div>
                          <small class="text-muted">{{ history.timestamp | date:'HH:mm:ss' }}</small>
                        </td>
                        <td>
                          <div class="fw-bold">{{ history.actor.userName }}</div>
                          <small class="text-muted">{{ history.actor.email }}</small>
                        </td>
                        <td>
                          <div class="d-flex align-items-center">
                            <span class="badge me-2" [ngClass]="getStatusBadgeClass(history.statusBefore)">
                              {{ history.statusBeforeLabel }}
                            </span>
                            <i class="fas fa-arrow-right text-muted mx-2"></i>
                            <span class="badge" [ngClass]="getStatusBadgeClass(history.statusAfter)">
                              {{ history.statusAfterLabel }}
                            </span>
                          </div>
                        </td>
                        <td>
                          <div class="text-dark">{{ history.description }}</div>
                          <small class="text-muted" *ngIf="getChangedFieldsCount(history.changes) > 0">
                            {{ getChangedFieldsCount(history.changes) }} trường thay đổi
                          </small>
                        </td>
                      </tr>
                      
                      <!-- Expanded row content -->
                      <tr *ngIf="isRowExpanded(i)" class="expanded-row">
                        <td colspan="5" class="p-0">
                          <div class="bg-light border-top">
                            <div class="p-3">
                              <h6 class="text-muted mb-3">
                                <i class="fas fa-list me-2"></i>Danh sách các field thay đổi
                              </h6>
                              <div class="row" *ngIf="getChangedFields(history).length > 0; else noChanges">
                                <div class="col-12">
                                  <div class="table-responsive">
                                    <table class="table table-sm table-borderless">
                                      <thead class="table-light">
                                        <tr>
                                          <th style="width: 200px;">Tên field</th>
                                          <th style="width: 200px;">Giá trị trước</th>
                                          <th style="width: 200px;">Giá trị sau</th>
                                          <th>Thay đổi</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr *ngFor="let field of getChangedFields(history)">
                                          <td>
                                            <span class="fw-bold">{{ getFieldDisplayName(field) }}</span>
                                          </td>
                                          <td>
                                            <span class="badge bg-danger text-white">
                                              {{ getFieldValueDisplay(getFieldBeforeValue(history, field)) }}
                                            </span>
                                          </td>
                                          <td>
                                            <span class="badge bg-success text-white">
                                              {{ getFieldValueDisplay(getFieldAfterValue(history, field)) }}
                                            </span>
                                          </td>
                                          <td>
                                            <i class="fas fa-arrow-right text-muted"></i>
                                          </td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              </div>
                              <ng-template #noChanges>
                                <div class="text-muted text-center py-3">
                                  <i class="fas fa-info-circle me-2"></i>
                                  Không có thông tin chi tiết về các field thay đổi
                                </div>
                              </ng-template>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
            <ng-template #noHistory>
              <div class="text-muted text-center py-4">
                <i class="fas fa-history text-muted mb-3" style="font-size: 3rem;"></i>
                <p>Chưa có lịch sử thay đổi cho vai trò này.</p>
              </div>
            </ng-template>
          </div>
        </div>
      </tab>
    </tabset>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Đóng</button>
  </div>
</ng-template>

<!-- Modal thêm mới vai trò -->
<ng-template #createModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-success fw-semibold">
        <i class="fas fa-plus-circle me-2"></i>Thêm mới vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.code.errors}"
                 appUpperNoSpace />
          <div *ngIf="submitted && roleForm.controls.code.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.code.errors.required">Mã vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.code.errors.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.name.errors}" />
          <div *ngIf="submitted && roleForm.controls.name.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors.required">Tên vai trò không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="2" placeholder="Nhập mô tả"></textarea>
        </div>
      </div>
      <div class="mt-3 small text-muted">
        <span *ngIf="currentUser">Tạo bởi: {{ currentUser.userName }} lúc {{ (now | date:'dd/MM/yyyy HH:mm') }}</span>
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
      </div>
      <div>
        <button type="button" class="btn btn-outline-primary me-2" (click)="saveDraftRole()">
          <i class="fas fa-save me-1"></i> Lưu nháp
        </button>
        <button type="button" class="btn btn-primary" (click)="onSubmitRole()">
          <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
        </button>
      </div>
    </div>
  </form>
</ng-template>

<!-- Modal phê duyệt yêu cầu -->
<ng-template #approveModal>
  <div class="modal-header">
    <h5 class="modal-title text-success fw-semibold">
      <i class="fas fa-check-circle me-2"></i> Xác nhận duyệt yêu cầu
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="card border-0 bg-light">
      <div class="card-body">
        <h6 class="card-title text-muted mb-3">
          <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
        </h6>
        <div class="row g-2">
          <div class="col-6">
            <small class="text-muted">ID yêu cầu:</small>
            <div class="fw-bold">{{ selectedItem?.requestId || selectedItem?.id }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Người tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedBy }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Ngày tạo:</small>
            <div class="fw-bold">{{ selectedItem?.requestedDate | date:'dd/MM/yyyy' }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted">Loại yêu cầu:</small>
            <div class="fw-bold">
              <app-badge [value]="selectedItem?.requestType" type="request"></app-badge>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-success" (click)="approveRole()">Xác nhận</button>
    <button type="button" class="btn btn-outline-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal từ chối yêu cầu -->
<ng-template #rejectModal>
  <form [formGroup]="rejectForm" (ngSubmit)="confirmRejectRole()" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-danger fw-semibold">
        <i class="fas fa-times-circle me-2"></i> Từ chối yêu cầu
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="position-relative">
        <label class="form-label">Lý do từ chối</label>
        <textarea
          class="form-control"
          formControlName="reason"
          rows="3"
          placeholder="Nhập lý do từ chối..."
          [ngClass]="{'is-invalid': submittedReject && rejectForm.controls.reason.errors}">
        </textarea>
        <div *ngIf="submittedReject && rejectForm.controls.reason.errors" class="invalid-tooltip">
          <span *ngIf="rejectForm.controls.reason.errors.required">Lý do không được để trống</span>
        </div>
      </div>
    </div>
    <div class="modal-footer border-top-0">
      <button type="submit" class="btn btn-danger" [disabled]="isRejecting">
        <i class="fas fa-times me-1" *ngIf="!isRejecting"></i>
        <span class="spinner-border spinner-border-sm me-1" *ngIf="isRejecting" role="status" aria-hidden="true"></span>
        {{ isRejecting ? 'Đang từ chối...' : 'Xác nhận từ chối' }}
      </button>
      <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="isRejecting">Hủy</button>
    </div>
  </form>
</ng-template>

<!-- Modal chỉnh sửa vai trò -->
<ng-template #editModal>
  <form [formGroup]="roleForm" class="needs-validation">
    <div class="modal-header">
      <h5 class="modal-title text-warning fw-semibold">
        <i class="fas fa-pen me-2"></i>Chỉnh sửa vai trò
      </h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
    </div>
    <div class="modal-body px-4 py-3">
      <div class="row gy-3">
        <div class="col-md-6 position-relative">
          <label class="form-label">Mã vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="code" placeholder="Nhập mã vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.code.errors}"
                 appUpperNoSpace />
          <div *ngIf="submitted && roleForm.controls.code.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.code.errors.required">Mã vai trò không được để trống</span>
            <span *ngIf="roleForm.controls.code.errors.pattern">Chỉ cho phép chữ và số</span>
          </div>
        </div>
        <div class="col-md-6 position-relative">
          <label class="form-label">Tên vai trò <span class="text-danger">*</span></label>
          <input type="text" class="form-control" formControlName="name" placeholder="Nhập tên vai trò"
                 [ngClass]="{'is-invalid': submitted && roleForm.controls.name.errors}" />
          <div *ngIf="submitted && roleForm.controls.name.errors" class="invalid-tooltip">
            <span *ngIf="roleForm.controls.name.errors.required">Tên vai trò không được để trống</span>
          </div>
        </div>
        <div class="col-md-12 position-relative">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" formControlName="description" rows="2" placeholder="Nhập mô tả"></textarea>
        </div>
      </div>
      <div class="mt-3 small text-muted">
        <span *ngIf="currentUser">Tạo bởi: {{ currentUser.userName }} lúc {{ (selectedItem?.requestedDate | date:'dd/MM/yyyy HH:mm') }}</span>
      </div>
      <div *ngIf="rejectedReason" class="alert alert-danger mt-3">
        <i class="fas fa-ban me-2"></i>
        ⛔ Yêu cầu trước đã bị từ chối bởi CHECKER lúc {{ selectedItem?.rejectedDate | date:'dd/MM/yyyy' }}<br>
        Lý do: {{ rejectedReason }}
      </div>
    </div>
    <div class="modal-footer border-top-0 d-flex justify-content-between">
      <div>
        <button *ngIf="(selectedItem?.status || '').toUpperCase() === 'DRAFT'" type="button" class="btn btn-danger" (click)="openDeleteDraftModal()">
          <i class="fas fa-trash-alt me-1"></i> Xoá nháp
        </button>
      </div>
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="modalRef?.hide()">Hủy</button>
        <ng-container *ngIf="(selectedItem?.status || '').toUpperCase() === 'DRAFT'; else normalEditBtns">
          <button type="button" class="btn btn-outline-primary me-2" (click)="saveDraftRole()">
            <i class="fas fa-save me-1"></i> Lưu nháp
          </button>
          <button type="button" class="btn btn-primary" (click)="onSubmitRole()">
            <i class="fas fa-paper-plane me-1"></i> Gửi duyệt
          </button>
        </ng-container>
        <ng-template #normalEditBtns>
          <button type="button" class="btn btn-warning" (click)="submitEditRoleForm()">
            <i class="fas fa-save me-1"></i> Lưu thay đổi
          </button>
        </ng-template>
      </div>
    </div>
  </form>
</ng-template>

<!-- Confirm modal trigger -->
<div *ngIf="showSubmitConfirm">
  <ng-container *ngTemplateOutlet="submitConfirmModal"></ng-container>
</div>

<!-- Modal xác nhận xóa -->
<ng-template #deleteModal>
  <div class="modal-header">
    <h5 class="modal-title text-danger fw-semibold">
      <i class="fas fa-trash-alt me-2"></i>Xác nhận xóa vai trò
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Bạn có chắc chắn muốn xóa vai trò này?
    </div>
    <div class="mt-3">
      <div class="mb-2">
        <span class="fw-bold text-muted">Mã vai trò:</span>
        <span class="ps-2">{{ selectedItem?.code }}</span>
      </div>
      <div class="mb-2">
        <span class="fw-bold text-muted">Tên vai trò:</span>
        <span class="ps-2">{{ selectedItem?.name }}</span>
      </div>
      <div class="mb-2">
        <span class="fw-bold text-muted">Mô tả:</span>
        <span class="ps-2">{{ selectedItem?.description || 'Không có' }}</span>
      </div>
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-danger" (click)="confirmDeleteRole()">
      <i class="fas fa-trash-alt me-1"></i> Xác nhận xóa
    </button>
    <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Modal xác nhận xóa nháp -->
<ng-template #deleteDraftModal>
  <div class="modal-header">
    <h5 class="modal-title text-danger fw-semibold">
      <i class="fas fa-trash-alt me-2"></i>Xác nhận xoá bản nháp
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  <div class="modal-body px-4 py-3">
    <div class="alert alert-warning">
      <i class="fas fa-exclamation-triangle me-2"></i>
      Bạn có chắc chắn muốn xoá bản nháp này?
    </div>
  </div>
  <div class="modal-footer border-top-0">
    <button type="button" class="btn btn-danger" (click)="confirmDeleteDraft()">
      <i class="fas fa-trash-alt me-1"></i> Xác nhận xoá
    </button>
    <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Hủy</button>
  </div>
</ng-template>

<!-- Enhanced Role Request Detail Modal -->
<ng-template #requestDetailModal>
  <div class="modal-header">
    <h5 class="modal-title fw-semibold">
      <i [class]="getRequestTypeIcon(getRequestType())" 
         [ngClass]="getRequestTypeColor(getRequestType())" 
         class="me-2"></i>
      Chi tiết yêu cầu vai trò
      <span *ngIf="getRequestType()" 
            [ngClass]="getRequestTypeBadgeClass(getRequestType())" 
            class="badge ms-2">
        {{ getRequestTypeLabel(getRequestType()) }}
      </span>
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalRef?.hide()"></button>
  </div>
  
  <div class="modal-body px-4 py-3">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin chi tiết...</p>
    </div>

    <!-- Content when data is loaded -->
    <div *ngIf="!isLoading && requestDetailData">
      <!-- Request Information -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-info-circle me-2"></i>Thông tin yêu cầu
              </h6>
                             <div class="row g-2">
                 <div class="col-6">
                   <small class="text-muted">ID yêu cầu:</small>
                   <div class="fw-bold">{{ requestDetailData.requestId || '—' }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Người tạo:</small>
                   <div class="fw-bold">{{ getCreatedBy() }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Ngày tạo:</small>
                   <div class="fw-bold">{{ getCreatedDate() | date:'dd/MM/yyyy' }}</div>
                 </div>
                 <div class="col-6">
                   <small class="text-muted">Loại yêu cầu:</small>
                  <div class="fw-bold">{{ getRequestTypeLabel(getRequestType()) }}</div>
                 </div>
               </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 bg-light">
            <div class="card-body">
              <h6 class="card-title text-muted mb-3">
                <i class="fas fa-tasks me-2"></i>Tóm tắt thay đổi
              </h6>
                             <div class="changes-summary">
                 <div *ngIf="getRequestType() === 'CREATE'" class="text-success">
                   <i class="fas fa-plus-circle me-1"></i>
                   <strong>Tạo mới vai trò:</strong> {{ getRoleName(requestDetailData.newData) }}
                 </div>
                 <div *ngIf="getRequestType() === 'UPDATE'" class="text-warning">
                   <i class="fas fa-edit me-1"></i>
                   <strong>Cập nhật vai trò:</strong> {{ getRoleName(requestDetailData.oldData) }}
                   <div class="small text-muted mt-1">
                     <span class="change-count">{{ getChangedFieldsCount() }}</span> trường thay đổi
                   </div>
                 </div>
                 <div *ngIf="getRequestType() === 'DELETE'" class="text-danger">
                   <i class="fas fa-trash-alt me-1"></i>
                   <strong>Xóa vai trò:</strong> {{ getRoleName(requestDetailData.oldData) }}
                 </div>
               </div>
            </div>
          </div>
        </div>
      </div>

             <!-- CREATE Request - Show new data only -->
       <div *ngIf="getRequestType() === 'CREATE'" class="card border-0">
         <div class="card-header bg-success bg-opacity-10 border-0">
           <h6 class="mb-0 text-success">
             <i class="fas fa-plus-circle me-2"></i>Dữ liệu mới sẽ được tạo
           </h6>
         </div>
         <div class="card-body">
           <div class="row g-3">
                           <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Mã vai trò</label>
                <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                  {{ getRoleCode(requestDetailData.newData) || '—' }}
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Tên vai trò</label>
                <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                  {{ getRoleName(requestDetailData.newData) || '—' }}
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold text-muted">Mô tả</label>
               <div class="text-dark ps-2 py-2 bg-success bg-opacity-10 rounded min-height-40">
                 {{ getRoleDescription(requestDetailData.newData) || '—' }}
               </div>
              </div>
           </div>
         </div>
       </div>

             <!-- UPDATE Request - Show comparison -->
       <div *ngIf="getRequestType() === 'UPDATE'" class="card border-0">
         <div class="card-header bg-warning bg-opacity-10 border-0">
           <h6 class="mb-0 text-warning">
             <i class="fas fa-edit me-2"></i>So sánh thay đổi
           </h6>
         </div>
         <div class="card-body">
           <div class="table-responsive">
             <table class="table table-bordered comparison-table">
               <thead class="table-light">
                 <tr>
                   <th style="width: 25%">Trường dữ liệu</th>
                   <th style="width: 37.5%">Giá trị cũ</th>
                   <th style="width: 37.5%">Giá trị mới</th>
                 </tr>
               </thead>
               <tbody>
                 <tr>
                   <td class="fw-bold">Mã vai trò</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleCode')}">
                     {{ getRoleCode(requestDetailData.oldData) }}
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleCode')}">
                     {{ getRoleCode(requestDetailData.newData) }}
                   </td>
                 </tr>
                 <tr>
                   <td class="fw-bold">Tên vai trò</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleName')}">
                     {{ getRoleName(requestDetailData.oldData) }}
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('roleName')}">
                     {{ getRoleName(requestDetailData.newData) }}
                   </td>
                 </tr>
                 <tr>
                   <td class="fw-bold">Quyền hạn</td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('permissions')}">
                     {{ getPermissions(requestDetailData.oldData).length }} quyền hạn
                   </td>
                   <td [ngClass]="{'bg-light-warning': hasChanges('permissions')}">
                     {{ getPermissions(requestDetailData.newData).length }} quyền hạn
                   </td>
                 </tr>
               </tbody>
             </table>
           </div>
         </div>
       </div>

             <!-- DELETE Request - Show data to be deleted -->
       <div *ngIf="getRequestType() === 'DELETE'" class="card border-0">
         <div class="card-header bg-danger bg-opacity-10 border-0">
           <h6 class="mb-0 text-danger">
             <i class="fas fa-trash-alt me-2"></i>Dữ liệu sẽ bị xóa
           </h6>
         </div>
         <div class="card-body">
           <div class="alert alert-danger">
             <i class="fas fa-exclamation-triangle me-2"></i>
             <strong>Cảnh báo:</strong> Vai trò này sẽ bị xóa vĩnh viễn sau khi được phê duyệt.
           </div>
           <div class="row g-3">
                           <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Mã vai trò</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  {{ getRoleCode(requestDetailData.oldData) || '—' }}
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold text-muted">Tên vai trò</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  {{ getRoleName(requestDetailData.oldData) || '—' }}
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold text-muted">Quyền hạn</label>
                <div class="text-dark ps-2 py-2 bg-danger bg-opacity-10 rounded min-height-40">
                  <span *ngIf="getPermissions(requestDetailData.oldData).length > 0; else noPermissionsDelete">
                    {{ getPermissions(requestDetailData.oldData).length }} quyền hạn
                  </span>
                  <ng-template #noPermissionsDelete>Không có quyền hạn</ng-template>
                </div>
              </div>
           </div>
         </div>
       </div>

             <!-- Rejection reason if applicable -->
       <div *ngIf="requestDetailData.rejectReason" class="alert alert-danger mt-3">
         <i class="fas fa-ban me-2"></i>
         <strong>Lý do từ chối:</strong> {{ requestDetailData.rejectReason }}
         <div class="small text-muted mt-1">
           Từ chối bởi: {{ requestDetailData.rejectedBy || '—' }} 
           lúc {{ requestDetailData.rejectedDate | date:'dd/MM/yyyy' }}
         </div>
       </div>
    </div>

    <!-- Error state -->
    <div *ngIf="!isLoading && !requestDetailData" class="text-center py-4">
      <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
      <p class="mt-2 text-muted">Không thể tải thông tin chi tiết</p>
    </div>
  </div>

  <div class="modal-footer border-top-0">
    <div class="d-flex justify-content-between w-100">
      <div>
        <button type="button" class="btn btn-outline-secondary" (click)="closeModal()" [disabled]="isApproving || isRejecting">
          <i class="fas fa-times me-1"></i> Đóng
        </button>
      </div>
      <div class="btn-group-approve-reject">
        <button type="button" class="btn btn-success me-2" (click)="approveRole()">
            Duyệt
        </button>
        <button type="button" class="btn btn-danger" (click)="openRejectModal()">
          <i class="fas fa-times me-1"></i> Từ chối
        </button>
      </div>
    </div>
  </div>
</ng-template>


