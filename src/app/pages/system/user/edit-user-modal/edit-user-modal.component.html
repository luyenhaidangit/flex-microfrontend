<!-- Edit User Modal -->
<div class="modal fade show d-block" *ngIf="isVisible" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-warning fw-semibold">
          <i class="fas fa-edit me-2"></i>Chỉnh sửa người dùng
        </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="onCancel()"></button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="needs-validation">
        <div class="modal-body px-4 py-3">
    <!-- Loading state for initial data -->
    <div *ngIf="isLoadingInitial" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang tải...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải thông tin người dùng...</p>
    </div>

    <!-- Form content -->
    <div *ngIf="!isLoadingInitial" class="row gy-3">
      <!-- Tên đăng nhập -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Tên đăng nhập <span class="text-danger">*</span></label>
        <input 
          type="text" 
          class="form-control non-editable-field" 
          formControlName="userName" 
          placeholder="Nhập tên đăng nhập"
          [ngClass]="{'is-invalid': isFieldInvalid('userName')}"
          appUpperNoSpace 
          readonly />
        <div class="form-text text-muted">
          <i class="fas fa-info-circle me-1"></i>Tên đăng nhập không thể thay đổi
        </div>
        <div *ngIf="isFieldInvalid('userName')" class="invalid-tooltip">
          {{ getFieldError('userName') }}
        </div>
      </div>

      <!-- Email -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Email <span class="text-danger">*</span></label>
        <input 
          type="email" 
          class="form-control" 
          formControlName="email" 
          placeholder="Nhập email"
          [ngClass]="{'is-invalid': isFieldInvalid('email')}" />
        <div *ngIf="isFieldInvalid('email')" class="invalid-tooltip">
          {{ getFieldError('email') }}
        </div>
      </div>

      <!-- Họ và tên -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
        <input 
          type="text" 
          class="form-control" 
          formControlName="fullName" 
          placeholder="Nhập họ và tên"
          [ngClass]="{'is-invalid': isFieldInvalid('fullName')}" />
        <div *ngIf="isFieldInvalid('fullName')" class="invalid-tooltip">
          {{ getFieldError('fullName') }}
        </div>
      </div>

      <!-- Chi nhánh -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Chi nhánh <span class="text-danger">*</span></label>
        <select 
          class="form-select" 
          formControlName="branchId"
          [ngClass]="{'is-invalid': isFieldInvalid('branchId')}"
          [disabled]="isLoading">
          <option [ngValue]="null">Chọn chi nhánh</option>
          <option *ngFor="let branch of branches" [ngValue]="branch.id">
            {{ branch.name }}
          </option>
        </select>
        <div *ngIf="isLoading" class="position-absolute top-50 end-0 translate-middle-y me-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
          </div>
        </div>
        <div *ngIf="isFieldInvalid('branchId')" class="invalid-tooltip">
          {{ getFieldError('branchId') }}
        </div>
      </div>

      <!-- Trạng thái -->
      <div class="col-md-6 position-relative">
        <label class="form-label">Trạng thái <span class="text-danger">*</span></label>
        <select 
          class="form-select" 
          formControlName="isActive"
          [ngClass]="{'is-invalid': isFieldInvalid('isActive')}">
          <option [ngValue]="true">Hoạt động</option>
          <option [ngValue]="false">Không hoạt động</option>
        </select>
        <div *ngIf="isFieldInvalid('isActive')" class="invalid-tooltip">
          {{ getFieldError('isActive') }}
        </div>
      </div>

    </div>

    <!-- Changes indicator -->
    <div *ngIf="!isLoadingInitial && hasChanges()" class="alert alert-info mt-3 mb-0">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>Lưu ý:</strong> Bạn đã thay đổi thông tin người dùng. Những thay đổi này sẽ được gửi để duyệt.
    </div>
  </div>

        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-secondary me-2" (click)="onCancel()" [disabled]="isSubmitting || isLoadingInitial">
            Hủy
          </button>
          <button 
            type="submit" 
            class="btn btn-warning" 
            [disabled]="isSubmitting || isLoadingInitial || userForm.invalid || !hasChanges()">
            <i class="fas fa-paper-plane me-1" *ngIf="!isSubmitting"></i>
            <span class="spinner-border spinner-border-sm me-1" *ngIf="isSubmitting" role="status" aria-hidden="true"></span>
            {{ isSubmitting ? 'Đang gửi...' : 'Gửi duyệt' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
